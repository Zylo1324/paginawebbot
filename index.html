<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zyl0</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000000; --ink:#f8fafc; --ink-soft:#d2d9e6; --muted:#9aa7bb;
      --field:rgba(14,18,26,.85); --field-focus:rgba(20,26,36,.92); --border:rgba(255,255,255,.12);
      --glass-border:rgba(255,255,255,.24);
      --glass-bg-top:rgba(255,255,255,.2);
      --glass-bg-bottom:rgba(15,23,42,.42);
      --glass-top-highlight:rgba(255,255,255,.24);
      --glass-shadow-soft:0 32px 64px rgba(3,6,10,.55);
      --glass-shadow-strong:0 18px 34px rgba(3,6,10,.38);
      --glass-shadow-inset:inset 0 1px 0 rgba(255,255,255,.3);
      --pill-bg:rgba(249,115,22,.18); --pill-ink:#ffd7a3; --btn:#f28a2d; --btn-ink:#1c130a;
      --ghost:rgba(255,255,255,.06); --ghost-border:rgba(255,255,255,.18);
      --ghost-hover-bg:rgba(255,255,255,.12); --ghost-active-bg:rgba(255,255,255,.18);
      --ghost-hover-border:rgba(255,255,255,.26); --ghost-active-border:rgba(255,255,255,.32);
      --ok:#4ade80; --warn:#fbbf24; --bad:#fb7185; --link:#7dd3fc;
      --success:#16f2a6; --danger:#f97373; --shadow:0 30px 60px rgba(3,6,10,.55);
      --toolbar-bg:rgba(6,9,15,.82);
      --input-bg:rgba(255,255,255,.05);
      --input-border:rgba(255,255,255,.14);
      --input-focus-border:rgba(125,211,252,.6);
      --input-focus-shadow:rgba(125,211,252,.2);
      --input-bg-top:rgba(255,255,255,.08);
      --input-bg-bottom:rgba(15,23,42,.28);
      --input-highlight:rgba(255,255,255,.18);
      --input-lowlight:rgba(2,6,14,.5);
      --input-shadow-raised:rgba(3,6,12,.24);
      --input-focus-glow:rgba(56,189,248,.3);
      --card-bg:rgba(255,255,255,.06);
      --sidebar-overlay-top:rgba(15,23,42,.92);
      --sidebar-overlay-bottom:rgba(8,12,24,.96);
      --table-card-bg:rgba(255,255,255,.05);
      --table-header-bg:#111827;
      --table-border:rgba(255,255,255,.08);
      --table-row-alt-bg:rgba(255,255,255,.03);
      --table-row-hover-bg:rgba(125,211,252,.12);
      --table-row-hover-shadow:inset 0 0 0 999px rgba(5,9,15,.12);
      --menu-bg:rgba(10,14,22,.96);
      --menu-hover-bg:rgba(255,255,255,.08);
      --modal-bg:rgba(10,14,22,.92);
      --backdrop-bg:rgba(3,6,11,.78);
      --chat-log-bg:rgba(255,255,255,.05);
      --ai-bubble-bg:rgba(15,20,28,.92);
      --ai-bubble-border:rgba(255,255,255,.12);
      --eye-bg:rgba(255,255,255,.08);
      --eye-border:rgba(255,255,255,.18);
      --addserv-bg:rgba(255,255,255,.04);
      --addserv-border:rgba(255,255,255,.26);
      --addserv-hover-bg:rgba(242,138,45,.16);
      --addserv-hover-border:rgba(242,138,45,.4);
      --addserv-active-bg:rgba(242,138,45,.24);
      --addserv-active-border:rgba(242,138,45,.5);
      --btn-base-bg-top:rgba(255,255,255,.16);
      --btn-base-bg-bottom:rgba(15,23,42,.28);
      --btn-base-hover-top:rgba(255,255,255,.22);
      --btn-base-hover-bottom:rgba(15,23,42,.36);
      --btn-base-active-top:rgba(255,255,255,.12);
      --btn-base-active-bottom:rgba(15,23,42,.22);
      --btn-base-shadow-soft:rgba(3,6,10,.55);
      --btn-base-shadow-strong:rgba(3,6,10,.32);
      --btn-base-shadow-hover-soft:rgba(3,6,10,.6);
      --btn-base-shadow-hover-strong:rgba(3,6,10,.4);
      --btn-base-shadow-active-soft:rgba(3,6,10,.45);
      --btn-base-shadow-active-strong:rgba(3,6,10,.5);
      --btn-base-highlight:rgba(255,255,255,.24);
      --btn-base-highlight-hover:rgba(255,255,255,.3);
      --btn-base-highlight-active:rgba(255,255,255,.2);
      --btn-ghost-bg-top:rgba(255,255,255,.18);
      --btn-ghost-bg-bottom:rgba(32,43,62,.24);
      --btn-ghost-hover-top:rgba(255,255,255,.24);
      --btn-ghost-hover-bottom:rgba(32,43,62,.3);
      --btn-ghost-active-top:rgba(255,255,255,.16);
      --btn-ghost-active-bottom:rgba(32,43,62,.24);
      --btn-ghost-shadow-soft:rgba(8,12,20,.45);
      --btn-ghost-shadow-strong:rgba(3,6,12,.32);
      --btn-ghost-shadow-hover-soft:rgba(8,12,20,.55);
      --btn-ghost-shadow-hover-strong:rgba(3,6,12,.42);
      --btn-ghost-shadow-active-soft:rgba(6,10,18,.4);
      --btn-ghost-shadow-active-strong:rgba(3,6,12,.5);
      --btn-ghost-highlight:rgba(255,255,255,.28);
      --btn-ghost-highlight-hover:rgba(255,255,255,.32);
      --btn-ghost-highlight-active:rgba(255,255,255,.24);
      --btn-primary-bg-top:#ffb15f;
      --btn-primary-bg-bottom:#d56715;
      --btn-primary-hover-top:#ffc070;
      --btn-primary-hover-bottom:#cf661d;
      --btn-primary-active-top:#f49a3c;
      --btn-primary-active-bottom:#d2641d;
      --btn-primary-shadow-soft:rgba(242,138,45,.5);
      --btn-primary-shadow-strong:rgba(199,98,18,.42);
      --btn-primary-shadow-hover-soft:rgba(242,138,45,.55);
      --btn-primary-shadow-hover-strong:rgba(199,98,18,.5);
      --btn-primary-shadow-active-soft:rgba(173,83,20,.48);
      --btn-primary-shadow-active-strong:rgba(130,60,14,.58);
      --btn-primary-highlight:rgba(255,237,213,.7);
      --btn-primary-highlight-hover:rgba(255,244,227,.78);
      --btn-primary-highlight-active:rgba(255,230,202,.62);
      --addserv-bg-top:rgba(255,255,255,.14);
      --addserv-bg-bottom:rgba(242,138,45,.18);
      --addserv-hover-top:rgba(242,138,45,.3);
      --addserv-hover-bottom:rgba(176,90,24,.26);
      --addserv-active-top:rgba(242,138,45,.24);
      --addserv-active-bottom:rgba(160,78,22,.28);
      --addserv-shadow-soft:rgba(5,9,15,.42);
      --addserv-shadow-strong:rgba(5,9,15,.28);
      --addserv-shadow-hover-soft:rgba(5,9,15,.52);
      --addserv-shadow-hover-strong:rgba(5,9,15,.36);
      --addserv-shadow-active-soft:rgba(5,9,15,.45);
      --addserv-shadow-active-strong:rgba(5,9,15,.5);
      --addserv-highlight:rgba(255,255,255,.24);
      --addserv-highlight-hover:rgba(255,255,255,.28);
      --addserv-highlight-active:rgba(255,255,255,.2);
      --launcher-bg-top:rgba(255,255,255,.32);
      --launcher-bg-bottom:rgba(12,20,32,.68);
      --launcher-hover-top:rgba(255,255,255,.38);
      --launcher-hover-bottom:rgba(16,26,42,.74);
      --launcher-active-top:rgba(236,242,255,.26);
      --launcher-active-bottom:rgba(10,16,28,.58);
      --launcher-shadow-soft:rgba(3,6,10,.55);
      --launcher-shadow-strong:rgba(3,6,10,.35);
      --launcher-shadow-hover-soft:rgba(3,6,10,.6);
      --launcher-shadow-hover-strong:rgba(3,6,10,.42);
      --launcher-shadow-active-soft:rgba(2,4,8,.5);
      --launcher-shadow-active-strong:rgba(2,4,8,.42);
      --launcher-highlight:rgba(255,255,255,.42);
      --launcher-highlight-hover:rgba(255,255,255,.48);
      --launcher-highlight-active:rgba(255,255,255,.34);
      --tag-border:rgba(255,255,255,.2);
      --tag-bg:rgba(255,255,255,.05);
      --hero-opacity:0;
      --hero-fade:1;
    }
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
    html,body{margin:0;min-height:100%;background:var(--bg);color:var(--ink)}
    body{position:relative;min-height:100vh;overflow-x:hidden;padding-left:0;transition:padding-left .3s ease;--hero-opacity:0}
    body.page-loaded{--hero-opacity:1}
    body::before{
      content:"";
      position:fixed;
      inset:-40%;
      background:
        linear-gradient(rgba(0,0,0,.78),rgba(0,0,0,.78)),
        url("https://images.unsplash.com/photo-1524230572899-a752b3835840?auto=format&fit=crop&w=1600&q=80") center/cover no-repeat fixed;
      pointer-events:none;
      z-index:-1;
      filter:blur(12px);
      transform:scale(1.06);
      opacity:var(--hero-opacity);
      opacity:calc(var(--hero-opacity) * var(--hero-fade));
      transition:opacity .6s ease,transform .6s ease,filter .6s ease;
    }
    body.page-loaded::before{filter:none;transform:scale(1)}
    body.theme-light{
      color-scheme:light;
      --bg:#f8fafc; --ink:#0f172a; --ink-soft:#1e293b; --muted:#475569;
      --field:#ffffff; --field-focus:#f1f5f9; --border:rgba(148,163,184,.35);
      --pill-bg:rgba(59,130,246,.14); --pill-ink:#1d4ed8;
      --ghost:rgba(226,232,240,.8); --ghost-border:rgba(148,163,184,.6);
      --ghost-hover-bg:rgba(148,163,184,.28); --ghost-active-bg:rgba(148,163,184,.36);
      --ghost-hover-border:rgba(100,116,139,.6); --ghost-active-border:rgba(71,85,105,.6);
      --shadow:0 18px 40px rgba(15,23,42,.12);
      --glass-border:rgba(148,163,184,.45);
      --glass-bg-top:rgba(255,255,255,.96);
      --glass-bg-bottom:rgba(226,232,240,.78);
      --glass-top-highlight:rgba(255,255,255,.72);
      --glass-shadow-soft:0 24px 44px rgba(15,23,42,.16);
      --glass-shadow-strong:0 12px 24px rgba(15,23,42,.12);
      --glass-shadow-inset:inset 0 1px 0 rgba(255,255,255,.85);
      --toolbar-bg:rgba(255,255,255,.86);
      --input-bg:#ffffff;
      --input-border:rgba(148,163,184,.55);
      --input-focus-border:rgba(37,99,235,.5);
      --input-focus-shadow:rgba(37,99,235,.18);
      --input-bg-top:rgba(255,255,255,.92);
      --input-bg-bottom:rgba(226,232,240,.82);
      --input-highlight:rgba(255,255,255,.9);
      --input-lowlight:rgba(148,163,184,.28);
      --input-shadow-raised:rgba(148,163,184,.22);
      --input-focus-glow:rgba(59,130,246,.26);
      --card-bg:#ffffff;
      --sidebar-overlay-top:rgba(241,245,249,.92);
      --sidebar-overlay-bottom:rgba(226,232,240,.94);
      --table-card-bg:#ffffff;
      --table-header-bg:#e2e8f0;
      --table-border:rgba(226,232,240,.9);
      --table-row-alt-bg:rgba(226,232,240,.6);
      --table-row-hover-bg:rgba(59,130,246,.12);
      --table-row-hover-shadow:inset 0 0 0 999px rgba(15,23,42,.08);
      --menu-bg:#ffffff;
      --menu-hover-bg:rgba(226,232,240,.9);
      --modal-bg:#ffffff;
      --backdrop-bg:rgba(15,23,42,.35);
      --chat-log-bg:#f8fafc;
      --ai-bubble-bg:#e2e8f0;
      --ai-bubble-border:rgba(148,163,184,.4);
      --eye-bg:#e2e8f0;
      --eye-border:rgba(148,163,184,.7);
      --addserv-bg:#e2e8f0;
      --addserv-border:rgba(148,163,184,.6);
      --addserv-hover-bg:rgba(59,130,246,.15);
      --addserv-hover-border:rgba(59,130,246,.45);
      --addserv-active-bg:rgba(59,130,246,.22);
      --addserv-active-border:rgba(37,99,235,.6);
      --tag-border:rgba(148,163,184,.6);
      --tag-bg:#e2e8f0;
      --btn-base-bg-top:#ffffff;
      --btn-base-bg-bottom:#dce6f6;
      --btn-base-hover-top:#f8fbff;
      --btn-base-hover-bottom:#cbdaf3;
      --btn-base-active-top:#eef3fb;
      --btn-base-active-bottom:#c2d1ee;
      --btn-base-shadow-soft:rgba(15,23,42,.16);
      --btn-base-shadow-strong:rgba(15,23,42,.1);
      --btn-base-shadow-hover-soft:rgba(15,23,42,.22);
      --btn-base-shadow-hover-strong:rgba(15,23,42,.14);
      --btn-base-shadow-active-soft:rgba(15,23,42,.16);
      --btn-base-shadow-active-strong:rgba(15,23,42,.2);
      --btn-base-highlight:rgba(255,255,255,.9);
      --btn-base-highlight-hover:rgba(255,255,255,.95);
      --btn-base-highlight-active:rgba(255,255,255,.82);
      --btn-ghost-bg-top:#f8fafc;
      --btn-ghost-bg-bottom:#dce5f3;
      --btn-ghost-hover-top:#eef4ff;
      --btn-ghost-hover-bottom:#cbd9f2;
      --btn-ghost-active-top:#e2e9f6;
      --btn-ghost-active-bottom:#c3d3eb;
      --btn-ghost-shadow-soft:rgba(15,23,42,.12);
      --btn-ghost-shadow-strong:rgba(15,23,42,.08);
      --btn-ghost-shadow-hover-soft:rgba(15,23,42,.18);
      --btn-ghost-shadow-hover-strong:rgba(15,23,42,.12);
      --btn-ghost-shadow-active-soft:rgba(15,23,42,.12);
      --btn-ghost-shadow-active-strong:rgba(15,23,42,.18);
      --btn-ghost-highlight:rgba(255,255,255,.85);
      --btn-ghost-highlight-hover:rgba(255,255,255,.9);
      --btn-ghost-highlight-active:rgba(255,255,255,.8);
      --btn-primary-shadow-soft:rgba(242,138,45,.36);
      --btn-primary-shadow-strong:rgba(199,98,18,.28);
      --btn-primary-shadow-hover-soft:rgba(242,138,45,.42);
      --btn-primary-shadow-hover-strong:rgba(199,98,18,.36);
      --btn-primary-shadow-active-soft:rgba(173,83,20,.32);
      --btn-primary-shadow-active-strong:rgba(130,60,14,.45);
      --btn-primary-highlight:rgba(255,244,227,.85);
      --btn-primary-highlight-hover:rgba(255,248,235,.9);
      --btn-primary-highlight-active:rgba(255,236,210,.78);
      --addserv-bg-top:#fdf4e0;
      --addserv-bg-bottom:#fbe1bf;
      --addserv-hover-top:#fbe1bf;
      --addserv-hover-bottom:#f0b978;
      --addserv-active-top:#f7c68f;
      --addserv-active-bottom:#e89b54;
      --addserv-shadow-soft:rgba(148,163,184,.32);
      --addserv-shadow-strong:rgba(148,163,184,.18);
      --addserv-shadow-hover-soft:rgba(148,163,184,.4);
      --addserv-shadow-hover-strong:rgba(148,163,184,.24);
      --addserv-shadow-active-soft:rgba(148,163,184,.32);
      --addserv-shadow-active-strong:rgba(148,163,184,.28);
      --addserv-highlight:rgba(255,255,255,.9);
      --addserv-highlight-hover:rgba(255,255,255,.95);
      --addserv-highlight-active:rgba(255,255,255,.88);
      --launcher-bg-top:#ffffff;
      --launcher-bg-bottom:#dbe6fb;
      --launcher-hover-top:#f8fbff;
      --launcher-hover-bottom:#c6d8f9;
      --launcher-active-top:#eef4ff;
      --launcher-active-bottom:#bed0f3;
      --launcher-shadow-soft:rgba(15,23,42,.16);
      --launcher-shadow-strong:rgba(15,23,42,.12);
      --launcher-shadow-hover-soft:rgba(15,23,42,.22);
      --launcher-shadow-hover-strong:rgba(15,23,42,.16);
      --launcher-shadow-active-soft:rgba(15,23,42,.18);
      --launcher-shadow-active-strong:rgba(15,23,42,.14);
      --launcher-highlight:rgba(255,255,255,.9);
      --launcher-highlight-hover:rgba(255,255,255,.95);
      --launcher-highlight-active:rgba(255,255,255,.85);
    }
    body.theme-light::before{
      background:radial-gradient(circle at 20% 20%,rgba(59,130,246,.15),rgba(148,163,184,0) 45%),
                 radial-gradient(circle at 80% 10%,rgba(16,185,129,.12),rgba(148,163,184,0) 52%),
                 radial-gradient(circle at 30% 80%,rgba(249,115,22,.12),rgba(148,163,184,0) 55%);
      filter:none;
      transform:none;
    }
    a{color:inherit}

    body.sidebar-expanded{padding-left:260px}
    /* ===== Sidebar y lanzador flotante ===== */
    .sidebar-launcher{position:fixed;top:20px;left:20px;width:54px;height:54px;border-radius:999px;border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(145deg,var(--launcher-bg-top),var(--launcher-bg-bottom));color:var(--ink);display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;z-index:60;
      box-shadow:0 20px 44px var(--launcher-shadow-soft),0 12px 22px var(--launcher-shadow-strong),inset 0 1px 0 var(--launcher-highlight);
      backdrop-filter:blur(18px);transition:left .3s ease,transform .2s ease,box-shadow .2s ease,background .2s ease,border-color .2s ease;
    }
    .sidebar-launcher:hover,.sidebar-launcher:focus-visible{transform:translateY(-1px);
      background:linear-gradient(145deg,var(--launcher-hover-top),var(--launcher-hover-bottom));
      box-shadow:0 24px 50px var(--launcher-shadow-hover-soft),0 14px 24px var(--launcher-shadow-hover-strong),inset 0 1px 0 var(--launcher-highlight-hover);
      border-color:rgba(255,255,255,.26);
    }
    .sidebar-launcher:active{transform:translateY(0);
      background:linear-gradient(145deg,var(--launcher-active-top),var(--launcher-active-bottom));
      box-shadow:0 16px 30px var(--launcher-shadow-active-soft),0 8px 16px var(--launcher-shadow-active-strong),inset 0 1px 0 var(--launcher-highlight-active);
    }
    .sidebar-launcher:focus-visible{outline:2px solid rgba(125,211,252,.35);outline-offset:3px}
    .sidebar-launcher.is-open{background:linear-gradient(145deg,var(--btn-primary-bg-top),var(--btn-primary-bg-bottom));color:var(--btn-ink);border-color:rgba(255,255,255,.24);
      box-shadow:0 24px 48px var(--btn-primary-shadow-soft),0 12px 24px var(--btn-primary-shadow-strong),inset 0 1px 0 var(--btn-primary-highlight);
    }
    .sidebar-launcher.is-open:hover,.sidebar-launcher.is-open:focus-visible{background:linear-gradient(145deg,var(--btn-primary-hover-top),var(--btn-primary-hover-bottom));
      box-shadow:0 28px 54px var(--btn-primary-shadow-hover-soft),0 14px 28px var(--btn-primary-shadow-hover-strong),inset 0 1px 0 var(--btn-primary-highlight-hover);
    }
    .sidebar-launcher.is-open:active{background:linear-gradient(145deg,var(--btn-primary-active-top),var(--btn-primary-active-bottom));
      box-shadow:0 18px 34px var(--btn-primary-shadow-active-soft),0 10px 20px var(--btn-primary-shadow-active-strong),inset 0 1px 0 var(--btn-primary-highlight-active);
    }
    body.sidebar-expanded .sidebar-launcher{left:220px}
    .sidebar{
      position:fixed;
      inset:0 auto 0 0;
      width:260px;
      background:
        linear-gradient(180deg,var(--glass-top-highlight),rgba(255,255,255,0) 36%),
        linear-gradient(160deg,var(--glass-bg-top),var(--glass-bg-bottom)),
        var(--card-bg);
      border-right:1px solid var(--glass-border);
      box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset);
      padding:60px 20px 20px;
      display:flex;
      flex-direction:column;
      z-index:30;
      transition:transform .3s ease,box-shadow .3s ease;
      overflow:hidden;
      transform:translateX(-100%);
    }
    .sidebar.pinned,.sidebar.peek{
      transform:translateX(0);
      box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset),0 12px 28px rgba(3,6,10,.32);
    }
    .sidebar .sidebar-content{position:relative;height:100%;overflow-y:auto;padding-right:6px}
    .sidebar .label{transition:opacity .2s ease}
    .btn{border:0;border-radius:14px;padding:10px 16px;cursor:pointer;font-weight:600;color:var(--ink);
      transition:background .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease,color .2s ease;
      --btn-bg-top:var(--btn-base-bg-top);
      --btn-bg-bottom:var(--btn-base-bg-bottom);
      --btn-hover-bg-top:var(--btn-base-hover-top);
      --btn-hover-bg-bottom:var(--btn-base-hover-bottom);
      --btn-active-bg-top:var(--btn-base-active-top);
      --btn-active-bg-bottom:var(--btn-base-active-bottom);
      --btn-shadow-soft:var(--btn-base-shadow-soft);
      --btn-shadow-strong:var(--btn-base-shadow-strong);
      --btn-shadow-hover-soft:var(--btn-base-shadow-hover-soft);
      --btn-shadow-hover-strong:var(--btn-base-shadow-hover-strong);
      --btn-shadow-active-soft:var(--btn-base-shadow-active-soft);
      --btn-shadow-active-strong:var(--btn-base-shadow-active-strong);
      --btn-highlight:var(--btn-base-highlight);
      --btn-highlight-hover:var(--btn-base-highlight-hover);
      --btn-highlight-active:var(--btn-base-highlight-active);
      background:linear-gradient(145deg,var(--btn-bg-top),var(--btn-bg-bottom));
      box-shadow:0 18px 32px var(--btn-shadow-soft),0 8px 16px var(--btn-shadow-strong),inset 0 1px 0 var(--btn-highlight);
    }
    .btn:hover,.btn:focus-visible{background:linear-gradient(145deg,var(--btn-hover-bg-top),var(--btn-hover-bg-bottom));
      box-shadow:0 22px 36px var(--btn-shadow-hover-soft),0 12px 20px var(--btn-shadow-hover-strong),inset 0 1px 0 var(--btn-highlight-hover);
      transform:translateY(-1px);
    }
    .btn:active{transform:translateY(0);
      background:linear-gradient(145deg,var(--btn-active-bg-top),var(--btn-active-bg-bottom));
      box-shadow:0 12px 22px var(--btn-shadow-active-soft),0 6px 12px var(--btn-shadow-active-strong),inset 0 1px 0 var(--btn-highlight-active);
    }
    .btn.ghost{border:1px solid var(--ghost-border);
      --btn-bg-top:var(--btn-ghost-bg-top);
      --btn-bg-bottom:var(--btn-ghost-bg-bottom);
      --btn-hover-bg-top:var(--btn-ghost-hover-top);
      --btn-hover-bg-bottom:var(--btn-ghost-hover-bottom);
      --btn-active-bg-top:var(--btn-ghost-active-top);
      --btn-active-bg-bottom:var(--btn-ghost-active-bottom);
      --btn-shadow-soft:var(--btn-ghost-shadow-soft);
      --btn-shadow-strong:var(--btn-ghost-shadow-strong);
      --btn-shadow-hover-soft:var(--btn-ghost-shadow-hover-soft);
      --btn-shadow-hover-strong:var(--btn-ghost-shadow-hover-strong);
      --btn-shadow-active-soft:var(--btn-ghost-shadow-active-soft);
      --btn-shadow-active-strong:var(--btn-ghost-shadow-active-strong);
      --btn-highlight:var(--btn-ghost-highlight);
      --btn-highlight-hover:var(--btn-ghost-highlight-hover);
      --btn-highlight-active:var(--btn-ghost-highlight-active);
      background:linear-gradient(145deg,var(--btn-bg-top),var(--btn-bg-bottom));
    }
    .btn.ghost:hover,.btn.ghost:focus-visible{border-color:var(--ghost-hover-border);
      background:linear-gradient(145deg,var(--btn-hover-bg-top),var(--btn-hover-bg-bottom));
    }
    .btn.ghost:active{border-color:var(--ghost-active-border);
      background:linear-gradient(145deg,var(--btn-active-bg-top),var(--btn-active-bg-bottom));
    }
    .btn.primary{color:var(--btn-ink);
      --btn-bg-top:var(--btn-primary-bg-top);
      --btn-bg-bottom:var(--btn-primary-bg-bottom);
      --btn-hover-bg-top:var(--btn-primary-hover-top);
      --btn-hover-bg-bottom:var(--btn-primary-hover-bottom);
      --btn-active-bg-top:var(--btn-primary-active-top);
      --btn-active-bg-bottom:var(--btn-primary-active-bottom);
      --btn-shadow-soft:var(--btn-primary-shadow-soft);
      --btn-shadow-strong:var(--btn-primary-shadow-strong);
      --btn-shadow-hover-soft:var(--btn-primary-shadow-hover-soft);
      --btn-shadow-hover-strong:var(--btn-primary-shadow-hover-strong);
      --btn-shadow-active-soft:var(--btn-primary-shadow-active-soft);
      --btn-shadow-active-strong:var(--btn-primary-shadow-active-strong);
      --btn-highlight:var(--btn-primary-highlight);
      --btn-highlight-hover:var(--btn-primary-highlight-hover);
      --btn-highlight-active:var(--btn-primary-highlight-active);
      background:linear-gradient(145deg,var(--btn-bg-top),var(--btn-bg-bottom));
    }
    .btn.primary:hover,.btn.primary:focus-visible{background:linear-gradient(145deg,var(--btn-hover-bg-top),var(--btn-hover-bg-bottom))}
    .btn.primary:active{background:linear-gradient(145deg,var(--btn-active-bg-top),var(--btn-active-bg-bottom))}
    .btn:focus-visible{outline:2px solid rgba(125,211,252,.45);outline-offset:3px}
    .linklike{background:none;border:0;color:var(--link);cursor:pointer;padding:0;font-weight:600;position:relative;transition:color .2s ease}
    .linklike::after{content:"";position:absolute;left:0;bottom:-2px;width:100%;height:2px;background:currentColor;transform:scaleX(0);transform-origin:left;transition:transform .2s ease}
    .linklike:hover,.linklike:focus-visible{color:#bae6fd}
    .linklike:hover::after,.linklike:focus-visible::after{transform:scaleX(1)}
    .linklike:active{color:#38bdf8}
    .linklike:active::after{transform:scaleX(1)}

    /* ===== Layout ===== */
    #Hero,#Registro,#TablaClientes{
      width:min(1200px,92vw);
      margin:0 auto;
      min-height:100vh;
      padding:36px 18px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap:32px;
    }
    #Hero{
      position:relative;
      z-index:0;
      text-align:center;
      padding-bottom:0;
    }
    .hero-section{
      opacity:calc(var(--hero-opacity)*var(--hero-fade));
      transform:translateY(24px);
      filter:blur(8px);
      transition:opacity .55s ease,transform .55s ease,filter .55s ease;
    }
    .hero-section .pill{
      opacity:calc(var(--hero-opacity)*var(--hero-fade));
      transform:translateY(18px);
      filter:blur(6px);
      transition:opacity .5s ease,transform .5s ease,filter .5s ease;
      transition-delay:.05s;
    }
    #Registro{
      align-items:stretch;
    }
    #TablaClientes{
      align-items:stretch;
      padding-bottom:80px;
    }
    #BarraServicio{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin:0;
    }
    .registration-columns{
      display:flex;
      flex-direction:column;
      gap:24px;
      width:100%;
    }
    #Formulario,#AccionesRapidas{width:100%;}
    @media(min-width:960px){
      .registration-columns{flex-direction:row;align-items:flex-start;}
      #Formulario{flex:2;}
      #AccionesRapidas{flex:1;}
    }
    .pill{display:block;width:max-content;margin:0 auto 14px;padding:6px 14px;border-radius:999px;background:var(--pill-bg);color:var(--pill-ink);border:1px solid var(--border);font-size:12px;letter-spacing:.08em;text-transform:uppercase}
    .hero-brand{display:flex;align-items:center;justify-content:center;flex-wrap:wrap;gap:clamp(12px,3vw,28px);margin:6px 0 24px;text-align:center;opacity:calc(var(--hero-opacity)*var(--hero-fade));transform:translateY(28px);filter:blur(8px);transition:opacity .6s ease,transform .6s ease,filter .6s ease;transition-delay:.12s}
    body.page-loaded .hero-section,
    body.page-loaded .hero-section .hero-brand,
    body.page-loaded .hero-section .pill{opacity:calc(var(--hero-opacity)*var(--hero-fade));transform:none;filter:none}
    .fade-scroll-target{opacity:1;transform:none;filter:none;transition:opacity .6s ease,transform .6s ease,filter .6s ease;will-change:opacity,transform,filter}
    .fade-scroll-target.is-hidden{opacity:0;transform:translateY(32px);filter:blur(12px)}
    .fade-scroll-target.is-visible{opacity:1;transform:none;filter:none}
    .hero-brand img{width:clamp(64px,16vw,132px);height:auto;flex-shrink:0;filter:drop-shadow(0 18px 36px rgba(0,0,0,.55));border-radius:24px}
    .hero-brand span{display:block;font-weight:800;letter-spacing:-0.02em;color:var(--ink);font-size:clamp(54px,16vw,144px);line-height:.95;text-shadow:0 12px 32px rgba(0,0,0,.55);text-transform:uppercase}
    @media(max-width:520px){
      .hero-brand span{font-size:clamp(42px,20vw,96px)}
    }

    /* ===== Servicio centrado ===== */
    .center{display:flex;justify-content:center;align-items:center;gap:10px;margin:8px 0 20px}
    .center .label{color:var(--ink-soft)}
    .addserv{border:1px dashed var(--addserv-border);background:linear-gradient(145deg,var(--addserv-bg-top),var(--addserv-bg-bottom));color:var(--ink);padding:8px 12px;border-radius:12px;font-size:15px;min-width:40px;text-align:center;
      transition:background .2s ease,border-color .2s ease,box-shadow .2s ease,transform .2s ease,color .2s ease;
      box-shadow:0 14px 28px var(--addserv-shadow-soft),0 6px 12px var(--addserv-shadow-strong),inset 0 1px 0 var(--addserv-highlight);
    }
    .addserv:hover,.addserv:focus-visible{background:linear-gradient(145deg,var(--addserv-hover-top),var(--addserv-hover-bottom));border-color:var(--addserv-hover-border);
      box-shadow:0 18px 34px var(--addserv-shadow-hover-soft),0 10px 18px var(--addserv-shadow-hover-strong),inset 0 1px 0 var(--addserv-highlight-hover);
      transform:translateY(-1px);
    }
    .addserv:active{background:linear-gradient(145deg,var(--addserv-active-top),var(--addserv-active-bottom));border-color:var(--addserv-active-border);
      transform:translateY(0);
      box-shadow:0 10px 20px var(--addserv-shadow-active-soft),0 4px 10px var(--addserv-shadow-active-strong),inset 0 1px 0 var(--addserv-highlight-active);
    }
    .addserv:focus-visible{outline:2px solid rgba(242,138,45,.35);outline-offset:2px}
    .addserv.remove{border-color:rgba(251,113,133,.45);color:#fecdd3;background:rgba(248,113,113,.16)}

    /* ===== Form (labels arriba) ===== */
    .form{
      background:
        linear-gradient(180deg,var(--glass-top-highlight),rgba(255,255,255,0) 40%),
        linear-gradient(160deg,var(--glass-bg-top),var(--glass-bg-bottom)),
        var(--card-bg);
      border-radius:20px;
      border:1px solid var(--glass-border);
      padding:28px;
      box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset);
      backdrop-filter:blur(22px);
    }
    .form-grid{display:grid;gap:16px}
    @media(min-width:720px){
      .form-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
    }
    .row{display:flex;flex-direction:column;gap:6px}
    .form-grid .row{min-width:0}
    .span-2{grid-column:1 / -1}
    .row label{color:var(--ink-soft);font-size:13px;font-weight:600;letter-spacing:.04em;text-transform:uppercase}
    input:not([type=checkbox]):not([type=radio]),select,textarea{
      width:100%;
      padding:14px;
      border:1px solid var(--input-border);
      border-radius:14px;
      color:var(--ink);
      outline:none;
      background-color:var(--field);
      background-image:linear-gradient(155deg,var(--input-bg-top),var(--input-bg-bottom));
      transition:background-color .2s ease,border-color .2s ease,box-shadow .25s ease,color .2s ease;
      box-shadow:inset 0 1px 0 var(--input-highlight),inset 0 -1px 0 var(--input-lowlight),0 8px 18px var(--input-shadow-raised);
    }
    input::placeholder,textarea::placeholder{color:var(--muted)}
    input:focus,select:focus,textarea:focus{
      border-color:var(--input-focus-border);
      background-color:var(--field-focus);
      box-shadow:0 0 0 1px var(--input-focus-border),0 0 0 4px var(--input-focus-glow),0 0 0 8px var(--input-focus-shadow),0 12px 24px var(--input-shadow-raised),inset 0 1px 0 var(--input-highlight),inset 0 -1px 0 var(--input-lowlight);
    }
    textarea{min-height:88px;resize:vertical}
    .actions{display:flex;justify-content:center;gap:10px;margin-top:18px}
    .small{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
    .side-card{
      background:
        linear-gradient(180deg,var(--glass-top-highlight),rgba(255,255,255,0) 38%),
        linear-gradient(160deg,var(--glass-bg-top),var(--glass-bg-bottom)),
        var(--card-bg);
      border-radius:20px;
      border:1px solid var(--glass-border);
      padding:28px;
      box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset);
      backdrop-filter:blur(22px);
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .side-card h2{margin:0;font-size:18px;color:var(--ink);font-weight:700}
    .side-card p{margin:0;color:var(--muted);font-size:14px}
    .side-card .actions{flex-direction:column;justify-content:flex-start}
    .side-card .actions .btn{width:100%}
    .side-card .small{text-align:left;margin-top:0}
    .pin-wrap{position:relative}
    .pin-wrap .eye,
    .email-toggle{
      border:1px solid var(--eye-border);
      background-color:var(--eye-bg);
      background-image:linear-gradient(155deg,var(--input-bg-top),var(--input-bg-bottom));
      color:var(--ink);
      border-radius:10px;
      padding:6px 8px;
      cursor:pointer;
      box-shadow:inset 0 1px 0 var(--input-highlight),inset 0 -1px 0 var(--input-lowlight),0 6px 12px var(--input-shadow-raised);
      transition:background-color .2s ease,border-color .2s ease,box-shadow .25s ease,color .2s ease;
    }
    .pin-wrap .eye{position:absolute;right:10px;top:50%;transform:translateY(-50%)}

    /* email dropdown toggle */
    .row.suggestion-source{position:relative}
    .row.suggestion-source input{padding-right:44px}
    .email-toggle{position:absolute;right:10px;top:50%;transform:translateY(-50%);line-height:1}
    .pin-wrap .eye:hover,
    .email-toggle:hover{
      background-color:var(--field-focus);
      border-color:var(--ghost-hover-border);
      box-shadow:inset 0 1px 0 var(--input-highlight),inset 0 -1px 0 var(--input-lowlight),0 8px 16px var(--input-shadow-raised);
    }
    .pin-wrap .eye:focus-visible,
    .email-toggle:focus-visible{
      border-color:var(--input-focus-border);
      background-color:var(--field-focus);
      box-shadow:0 0 0 1px var(--input-focus-border),0 0 0 4px var(--input-focus-glow),0 0 0 8px var(--input-focus-shadow),0 8px 18px var(--input-shadow-raised),inset 0 1px 0 var(--input-highlight),inset 0 -1px 0 var(--input-lowlight);
      outline:none;
    }

    .linked-email-wrap{display:flex;gap:10px;align-items:center}
    .btn.icon-only{width:44px;height:44px;padding:0;display:flex;align-items:center;justify-content:center;font-size:24px;line-height:1}
    .btn.ghost.danger{color:var(--danger);border-color:rgba(249,113,113,.4)}
    .btn.ghost.danger:hover,.btn.ghost.danger:focus-visible{background:rgba(249,113,113,.18);border-color:rgba(249,113,113,.45)}
    .btn.ghost.danger:active{background:rgba(249,113,113,.24);border-color:rgba(249,113,113,.5)}
    .btn.ghost.danger:disabled{opacity:.4;cursor:not-allowed;box-shadow:none;transform:none}

    .row.suggestion-source .suggestion-dropdown,
    .row.suggestion-source .suggestion-dropdown.open{left:0;right:0}

    .suggestion-dropdown{position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--menu-bg);border:1px solid var(--ghost-border);border-radius:14px;padding:6px 0;box-shadow:var(--shadow);display:none;z-index:40;max-height:260px;overflow:auto}
    .suggestion-dropdown.open{display:block}
    .suggestion-item{width:100%;text-align:left;background:none;border:0;color:var(--ink);padding:10px 16px;cursor:pointer;display:flex;flex-direction:column;gap:4px;font-size:14px}
    .suggestion-item:hover,.suggestion-item:focus-visible{background:var(--menu-hover-bg);outline:none}
    .suggestion-item.is-active{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    .suggestion-email{font-weight:600}
    .suggestion-hint{color:var(--muted);font-size:12px}
    .suggestion-empty{padding:12px 16px;color:var(--muted);font-size:13px}

    /* ===== Tabla ===== */
    .table-section{display:flex;flex-direction:column;gap:18px;width:100%}
    .table-header{display:flex;flex-direction:column;gap:6px}
    @media(min-width:720px){
      .table-header{flex-direction:row;align-items:flex-end;justify-content:space-between}
    }
    .table-header h2{margin:0;font-size:22px;font-weight:700;color:var(--ink);text-shadow:0 10px 20px rgba(0,0,0,.35)}
    .table-header p{margin:0;color:var(--muted);font-size:14px}
    .table-card{
      position:relative;
      background:
        linear-gradient(180deg,var(--glass-top-highlight),rgba(255,255,255,0) 42%),
        linear-gradient(160deg,var(--glass-bg-top),var(--glass-bg-bottom)),
        var(--table-card-bg);
      border-radius:20px;
      border:1px solid var(--glass-border);
      box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset);
      overflow:visible;
      backdrop-filter:blur(18px);
    }
    .table-scroll{position:relative;width:100%;overflow-x:auto;overscroll-behavior-x:contain;-webkit-overflow-scrolling:touch;scrollbar-width:thin;scrollbar-color:rgba(125,211,252,.6) transparent;scrollbar-gutter:stable both-edges}
    .table-scroll:focus-visible{outline:2px solid rgba(125,211,252,.45);outline-offset:4px}
    .table-scroll::-webkit-scrollbar{height:10px}
    .table-scroll::-webkit-scrollbar-track{background:transparent}
    .table-scroll::-webkit-scrollbar-thumb{background:rgba(125,211,252,.65);border-radius:999px;border:3px solid rgba(0,0,0,0)}
    table{width:100%;min-width:100%;border-collapse:separate;border-spacing:0;border-radius:inherit}
    th,td{padding:14px 16px;border-bottom:1px solid var(--table-border);font-size:14px;word-break:break-word;overflow-wrap:anywhere}
    th{text-align:left;color:var(--muted);font-weight:700;letter-spacing:.08em;font-size:12px;text-transform:uppercase}
    td{color:var(--ink);font-weight:500}
    tbody tr{transition:background-color .2s ease,box-shadow .2s ease}
    tbody tr:nth-child(even){background:var(--table-row-alt-bg)}
    tbody tr:hover{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    thead th:first-child{border-top-left-radius:20px}
    thead th:last-child{border-top-right-radius:20px}
    tbody tr:last-child td:first-child{border-bottom-left-radius:20px}
    tbody tr:last-child td:last-child{border-bottom-right-radius:20px}
    .table-card th,.table-card td{background-clip:padding-box}
    .cell-actions{text-align:right}
    @media(max-width:639px){
      .table-card{padding:12px}
      .table-scroll{scrollbar-width:auto}
      #tabla{display:block}
      #tabla thead{display:none}
      #tabla tbody{display:grid;gap:16px;padding:4px 0}
      #tabla tbody tr{display:grid;grid-template-columns:1fr;gap:12px;padding:18px;border-radius:18px;border:1px solid var(--table-border);background:var(--table-card-bg);box-shadow:0 18px 32px rgba(5,9,15,.35)}
      #tabla tbody tr:nth-child(even){background:var(--table-card-bg)}
      #tabla tbody tr:hover{background:var(--table-row-hover-bg);box-shadow:0 22px 38px rgba(5,9,15,.45)}
      #tabla tbody tr td{display:grid;gap:6px;padding:0;border:0;background:transparent;text-align:left}
      #tabla tbody tr td::before{content:attr(data-label);font-size:12px;font-weight:600;letter-spacing:.08em;text-transform:uppercase;color:var(--muted)}
      #tabla tbody tr td[data-label=""]::before{content:'';display:none}
      #tabla tbody tr td .tag{justify-self:start}
      .cell-actions{justify-items:end}
      .cell-actions .menu-wrap{justify-self:end}
    }
    @media(min-width:640px){
      #tabla{display:table}
      .table-scroll thead th{position:sticky;top:0;background:var(--table-header-bg);z-index:2;box-shadow:0 1px 0 var(--table-border);border-bottom:1px solid var(--table-border)}
      #tabla thead{display:table-header-group}
      #tabla tbody{display:table-row-group}
      #tabla tbody tr{display:table-row}
      #tabla tbody tr td{display:table-cell;padding:14px 16px}
      #tabla tbody tr td::before{display:none}
    }
    .tag{font-size:12px;padding:4px 10px;border-radius:999px;display:inline-block;border:1px solid var(--tag-border);background:var(--tag-bg);color:var(--ink);backdrop-filter:blur(12px)}
    .tag.ok{color:var(--ok);background:rgba(74,222,128,.16);border-color:rgba(74,222,128,.38)}
    .tag.warn{color:var(--warn);background:rgba(251,191,36,.16);border-color:rgba(251,191,36,.38)}
    .tag.bad{color:var(--bad);background:rgba(251,113,133,.2);border-color:rgba(251,113,133,.4)}

    /* ===== Kebab ‚ãØ men√∫ ===== */
    .menu-wrap{position:relative;display:inline-flex;align-items:center;gap:8px}
    .row-menu-indicator{border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);border-radius:12px;padding:6px 10px;line-height:1;color:var(--ink-soft);font-size:18px;letter-spacing:2px;transition:background-color .2s ease,border-color .2s ease,color .2s ease;user-select:none}
    tr[aria-expanded="true"] .row-menu-indicator{background:rgba(255,255,255,.12);border-color:rgba(255,255,255,.28);color:var(--ink)}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:var(--menu-bg);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);min-width:180px;padding:8px;opacity:0;visibility:hidden;pointer-events:none;transform:translateY(-6px);transition:opacity .2s ease,transform .2s ease;z-index:50;backdrop-filter:blur(18px)}
    .menu.open{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
    .menu-item{display:block;width:100%;text-align:left;background:transparent;border:1px solid transparent;border-radius:10px;padding:10px 12px;cursor:pointer;font-size:14px;color:var(--ink);transition:background-color .15s ease,border-color .15s ease,color .15s ease}
    .menu-item:hover{background:var(--menu-hover-bg)}
    .menu-item.danger{color:var(--bad);border:1px solid rgba(251,113,133,.35);background:rgba(251,113,133,.12)}
    .menu-item.danger:hover{background:rgba(251,113,133,.2);border-color:rgba(251,113,133,.5)}

    /* ===== Modales ===== */
    .modal-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px;background:var(--backdrop-bg);opacity:0;visibility:hidden;pointer-events:none;transform:translateY(6px);transition:opacity .2s ease,transform .2s ease;z-index:100;backdrop-filter:blur(12px)}
    .modal-backdrop.open{opacity:1;visibility:visible;pointer-events:auto;transform:translateY(0)}
    .modal{
      background:
        linear-gradient(180deg,var(--glass-top-highlight),rgba(255,255,255,0) 38%),
        linear-gradient(160deg,var(--glass-bg-top),var(--glass-bg-bottom)),
        var(--modal-bg);
      border:1px solid var(--glass-border);
      border-radius:18px;
      width:min(760px,96vw);
      max-height:90vh;
      display:flex;
      flex-direction:column;
      box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset);
      color:var(--ink);
      backdrop-filter:blur(22px);
    }
    .modal header{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
    .modal .body{padding:16px 18px;color:var(--ink)}
    .modal.chat-modal{
      width:min(1100px,98vw);
      height:min(90vh,840px);
      max-height:90vh;
      background:var(--modal-bg);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      backdrop-filter:none;
      overflow:hidden;
    }
    .modal.chat-modal header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:26px 32px 20px;
      border-bottom:1px solid var(--border);
      background:var(--field);
    }
    .modal.chat-modal header .chat-header-actions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .modal.chat-modal header strong{
      font-size:1.6rem;
      font-weight:700;
      letter-spacing:-0.01em;
      color:var(--ink);
    }
    .modal.chat-modal .body{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:24px;
      padding:28px 32px 32px;
      color:var(--ink);
      background:var(--modal-bg);
      overflow:hidden;
    }

    /* ===== Chat (Gemini) ===== */
    .section-head{font-weight:700;margin-bottom:8px;color:var(--ink);text-shadow:0 10px 24px rgba(0,0,0,.45)}
    .chat-log{flex:1;min-height:420px;max-height:calc(100% - 140px);overflow:auto;border:1px solid var(--border);border-radius:18px;padding:22px 24px;background:var(--field);display:flex;flex-direction:column;gap:14px;box-shadow:inset 0 1px 0 rgba(255,255,255,.04)}
    .chat-modal .chat-log{background:var(--field);}
    .chat-log.is-empty{justify-content:center;align-items:center;gap:0;text-align:center;padding:32px 40px;}
    .chat-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;max-width:420px;margin:0 auto;color:var(--muted);line-height:1.6;}
    .chat-empty .chat-empty-emoji{font-size:2.4rem;line-height:1;}
    .chat-empty h3{margin:0;font-size:1.45rem;font-weight:700;color:var(--ink);letter-spacing:-0.01em;}
    .chat-empty p{margin:0;font-size:1.05rem;color:var(--muted);}
    .chat-msg{margin:0;display:flex}
    .chat-msg.user{justify-content:flex-end}
    .chat-msg .bubble{max-width:85%;padding:12px 16px;border-radius:16px;white-space:normal;line-height:1.6;font-size:1rem}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .chat-msg.loading .bubble{display:flex;align-items:center;justify-content:center;gap:10px;min-height:44px;color:var(--muted)}
    .chat-spinner{width:20px;height:20px;border-radius:50%;border:3px solid rgba(4,11,28,.12);border-top-color:var(--btn);animation:spin .8s linear infinite}
    .chat-msg.user .chat-spinner{border-color:rgba(255,255,255,.4);border-top-color:rgba(255,255,255,.95)}
    .chat-msg .bubble p{margin:0}
    .chat-msg .bubble p+p{margin-top:8px}
    .chat-msg .bubble ul,
    .chat-msg .bubble ol{margin:8px 0 0;padding-left:22px}
    .chat-msg .bubble ul:first-child,
    .chat-msg .bubble ol:first-child{margin-top:0}
    .chat-msg .bubble li{margin:4px 0}
    .chat-msg .bubble li>ul,
    .chat-msg .bubble li>ol{margin-top:4px}
    .chat-msg .bubble table{width:100%;border-collapse:separate;border-spacing:0;margin:10px 0;border-radius:12px;overflow:hidden;background:var(--table-card-bg);border:1px solid var(--table-border);box-shadow:inset 0 1px 0 rgba(255,255,255,.05)}
    .chat-msg .bubble table:first-child{margin-top:0}
    .chat-msg .bubble table:last-child{margin-bottom:0}
    .chat-msg .bubble thead{background:var(--table-header-bg)}
    .chat-msg .bubble thead th{padding:10px 12px;font-weight:600;text-align:left;color:var(--ink)}
    .chat-msg .bubble tbody{background:transparent}
    .chat-msg .bubble tbody tr:nth-child(even){background:var(--table-row-alt-bg)}
    .chat-msg .bubble tbody tr:hover{background:var(--table-row-hover-bg);box-shadow:var(--table-row-hover-shadow)}
    .chat-msg .bubble tbody td{padding:10px 12px;border-top:1px solid var(--table-border)}
    .chat-msg .bubble th,
    .chat-msg .bubble td{font-size:.95em;vertical-align:top}
    .chat-msg.user .bubble{background:var(--btn);color:var(--btn-ink);border:1px solid rgba(255,255,255,.18);box-shadow:0 18px 34px rgba(242,138,45,.35);white-space:pre-wrap}
    .chat-msg.ai .bubble{background:var(--ai-bubble-bg);border:1px solid var(--ai-bubble-border);color:var(--ink);box-shadow:0 14px 30px rgba(0,0,0,.42)}
    .chat-modal .composer{display:grid;grid-template-columns:1fr auto;gap:12px;padding:20px 22px;border-radius:16px;border:1px solid var(--border);background:var(--field)}
    .chat-modal .composer textarea{
      padding:14px 16px;
      font-size:1rem;
      border-radius:12px;
      line-height:1.45;
      min-height:52px;
      max-height:220px;
      resize:none;
      overflow-y:hidden;
    }
    .chat-modal .composer button{min-width:120px;font-size:1rem;font-weight:600}
    .chat-modal .body .small{margin:0;text-align:left;color:var(--muted)}
    .chat-modal .chat-share{display:flex;align-items:center;gap:10px;font-size:13px}
    .chat-modal .chat-share input{margin:0;width:auto;height:auto;accent-color:var(--btn);cursor:pointer}
    .chat-modal .chat-note{font-size:12px;line-height:1.5}

    /* ===== Tokens de tema ===== */
    .sidebar-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:16px}
    .sidebar-list li{display:flex;flex-direction:column;gap:8px;color:var(--ink)}
    .sidebar-list li button.btn{align-self:flex-start}
    .auth-controls{gap:12px}
    .sidebar input,.sidebar select{border:1px solid var(--input-border);background:var(--input-bg);color:var(--ink)}
    .sidebar-search{position:relative;display:flex;align-items:center}
    .sidebar-search-icon{position:absolute;left:14px;display:flex;align-items:center;justify-content:center;color:var(--muted);pointer-events:none;font-size:16px}
    .sidebar-search input{padding-left:42px}
    .sidebar-search:focus-within .sidebar-search-icon{color:var(--ink)}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .menu-item[aria-checked="true"]{background:var(--ghost);border:1px solid var(--ghost-border);font-weight:600}

    @media(max-width:960px){ body.sidebar-expanded{padding-left:0} }
    @media(max-width:768px){
      .sidebar{
        box-shadow:none;
        background:linear-gradient(160deg,var(--sidebar-overlay-top),var(--sidebar-overlay-bottom));
      }
      .sidebar.pinned,.sidebar.peek{box-shadow:var(--glass-shadow-soft),var(--glass-shadow-strong),var(--glass-shadow-inset),0 12px 24px rgba(3,6,10,.28)}
      body.sidebar-expanded .sidebar-launcher{left:20px}
    }
  </style>
</head>
<body>
  <button type="button" id="sidebarLauncher" class="sidebar-launcher" aria-controls="sidebar" aria-label="Abrir navegaci√≥n" aria-expanded="false">‚ò∞</button>

  <aside class="sidebar" id="sidebar" data-pinned="false" aria-hidden="true">
    <div class="sidebar-content">
      <nav aria-label="Controles principales">
        <ul class="sidebar-list">
          <li>
            <div class="sidebar-search">
              <span class="sidebar-search-icon" aria-hidden="true">üîç</span>
              <label class="sr-only" for="q">Buscar</label>
              <input id="q" placeholder="Buscar por nombre, email o servicio‚Ä¶"/>
            </div>
          </li>
          <li>
            <label class="label" for="filterEstado">Estado</label>
            <select id="filterEstado">
              <option value="">Todos</option>
              <option value="vigente">Vigentes</option>
              <option value="pronto">Por vencer (‚â§7 d√≠as)</option>
              <option value="vencida">Vencidas</option>
            </select>
          </li>
          <li>
            <div class="menu-wrap theme-switcher">
              <button type="button" class="btn ghost theme-btn label" id="btnTheme" data-menu-toggle aria-haspopup="menu" aria-expanded="false">
                <span class="theme-btn-label label">Tema: <span id="themeLabel">Oscuro</span></span>
                <span class="theme-btn-icon" aria-hidden="true">‚ñæ</span>
              </button>
              <div class="menu" id="themeMenu" role="menu" aria-hidden="true">
                <button class="menu-item" type="button" role="menuitemradio" data-theme-option="dark" aria-checked="true">Oscuro</button>
                <button class="menu-item" type="button" role="menuitemradio" data-theme-option="light" aria-checked="false">Claro</button>
              </div>
            </div>
          </li>
          <li class="auth-controls">
            <button class="btn ghost label" id="btnAuthOpen">Acceder</button>
            <button class="btn ghost label" id="btnLogout" style="display:none">Cerrar sesi√≥n</button>
            <span id="userInfo" class="pill label" style="display:none"></span>
          </li>
          <li>
            <button class="btn ghost label" id="btnLinkedOpen">Correos enlazados</button>
          </li>
          <li>
            <button class="btn ghost label" id="btnChatOpen" title="Abrir chat con Gemini">Chat Gemini</button>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <main id="MainContent">
    <section id="Hero" class="page-section hero-section fade-scroll-target is-hidden">
      <span class="pill">importante</span>
      <div class="hero-brand" role="heading" aria-level="1">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%237dd3fc'/%3E%3Cstop offset='55%25' stop-color='%2316f2a6'/%3E%3Cstop offset='100%25' stop-color='%23f28a2d'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath fill='url(%23g)' d='M98.7 22.3C70.8 12.7 38.5 18.4 22.9 41.3 7.3 64.1 6.9 96 33 96c23.2 0 46.4-23.4 57.4-48.6 5.5-12.7 7.7-23.5 8.3-25.1Z'/%3E%3Cpath fill='none' stroke='rgba(255,255,255,0.6)' stroke-width='6' stroke-linecap='round' d='M36 74c16-8 36-28 47-50'/%3E%3C/svg%3E" alt="Hoja Super Zylo" loading="lazy"/>
        <span>Super Zylo</span>
      </div>
    </section>

    <section id="Registro" class="page-section registration-section fade-scroll-target is-hidden">
      <div id="BarraServicio" class="center service-bar">
        <div class="label">Servicio</div>
        <select id="servicio" style="max-width:260px"></select>
        <button id="btnAgregarServicio" class="addserv" aria-label="Agregar servicio" title="Agregar servicio">+</button>
        <button id="btnEliminarServicio" class="addserv remove" aria-label="Eliminar servicio" title="Eliminar servicio">‚àí</button>
      </div>
      <div class="registration-columns">
        <section id="Formulario" class="form">
          <div class="form-grid">
            <div class="row">
              <label for="nombre">Nombre</label>
              <input id="nombre" placeholder="Escribe"/>
            </div>

            <!-- EMAIL con dropdown contextual por servicio -->
            <div class="row suggestion-source">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="ej: cliente@mail.com" aria-expanded="false" aria-controls="emailSuggestionDropdown" />
              <button class="email-toggle" id="emailDropdownToggle" type="button" aria-label="Mostrar correos guardados">‚ñæ</button>
              <div id="emailSuggestionDropdown" class="suggestion-dropdown" role="listbox" aria-hidden="true"></div>
            </div>

            <div class="row">
              <label for="telefono">Tel√©fono</label>
              <input id="telefono" placeholder="+51 ‚Ä¶"/>
            </div>
            <div class="row">
              <label for="inicio">Fecha</label>
              <input id="inicio" type="date" />
            </div>
            <div class="row">
              <label for="vence">Vence</label>
              <input id="vence" type="date" />
            </div>
            <div class="row">
              <label for="pin">PIN</label>
              <div class="pin-wrap">
                <input id="pin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
                <button type="button" class="eye" id="togglePin" aria-label="Mostrar/ocultar PIN">üëÅ</button>
              </div>
            </div>
            <div class="row">
              <label for="categoria">Categor√≠a</label>
              <select id="categoria">
                <option value="">Selecciona una opci√≥n</option>
                <option>Premium</option>
                <option>Est√°ndar</option>
                <option>B√°sico</option>
              </select>
            </div>
            <div class="row span-2">
              <label for="notas">Notas</label>
              <textarea id="notas" placeholder="Plan, precio, usuario, etc."></textarea>
            </div>
          </div>
        </section>

        <aside id="AccionesRapidas" class="side-card">
          <h2>Acciones r√°pidas</h2>
          <p>Guarda el nuevo cliente o limpia el formulario antes de continuar.</p>
          <div class="actions">
            <button class="btn primary" id="btnGuardar">Agregar</button>
            <button class="btn ghost" id="btnLimpiar">Limpiar</button>
          </div>
          <div class="small" id="msg"></div>
        </aside>
      </div>
    </section>

    <section id="TablaClientes" class="page-section table-section fade-scroll-target is-hidden">
      <div class="table-header">
        <h2 id="clientesTitulo">Clientes registrados</h2>
        <p>Consulta el listado completo y gestiona cada registro.</p>
      </div>
      <div class="table-card">
        <div class="table-scroll" role="region" aria-labelledby="clientesTitulo" tabindex="0">
          <table id="tabla">
            <thead>
              <tr>
                <th>Nombre</th><th>Email</th><th>Servicio</th>
                <th>Inicio</th><th>Vence</th><th>Estado</th><th>D√≠as</th><th><span class="sr-only">Acciones</span></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Modal Chat Gemini ===== -->
  <div id="chatModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal chat-modal" role="dialog" aria-label="Chat Gemini">
      <header>
        <strong>Chat Gemini</strong>
        <div class="chat-header-actions">
          <button class="btn ghost" id="btnChatClear" type="button">Vaciar chat</button>
          <button class="btn ghost" id="btnChatClose" type="button">Cerrar</button>
        </div>
      </header>
      <div class="body">
        <div id="chatLog" class="chat-log"></div>
        <div class="composer">
          <textarea id="chatInput" placeholder="Escribe un mensaje‚Ä¶"></textarea>
          <button class="btn primary" id="btnSend">Enviar</button>
        </div>
        <label class="small chat-share"><input type="checkbox" id="shareSecrets"> Compartir datos sensibles (PIN y notas)</label>
        <div class="small chat-note">Conexi√≥n directa a Gemini desde el navegador (API key expuesta).</div>
      </div>
    </div>
  </div>

  <!-- ===== Modal Acceso (login/registro en 1) ===== -->
  <div id="authModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Acceder">
      <header>
        <strong>Acceder</strong>
        <button class="btn ghost" id="btnAuthClose">Cancelar</button>
      </header>
      <div class="body">
        <div class="row">
          <label for="authEmail">Correo</label>
          <input id="authEmail" type="email" placeholder="tucorreo@ejemplo.com" autocomplete="email">
        </div>
        <div class="row">
          <label for="authPass">Contrase√±a</label>
          <div class="pin-wrap">
            <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            <button type="button" class="eye" id="toggleAuthPass" aria-label="Mostrar/ocultar contrase√±a">üëÅ</button>
          </div>
        </div>

        <div class="small" style="text-align:left;margin-top:0">
          <button id="btnForgot" class="linklike" type="button">¬øOlvidaste tu contrase√±a?</button>
        </div>

        <div class="actions" style="justify-content:flex-end">
          <button class="btn primary" id="btnAuthSubmit">Continuar</button>
        </div>
        <div class="small" id="authHelp">Si es tu primera vez, crearemos tu cuenta autom√°ticamente.</div>
        <div class="small" id="authError" style="color:var(--danger)"></div>
      </div>
    </div>
  </div>

  <!-- ===== Modal Correos enlazados ===== -->
  <div id="linkedModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-label="Correos enlazados">
      <header>
        <strong>Correos enlazados</strong>
        <button class="btn ghost" id="btnLinkedHeaderClose" type="button">Cancelar</button>
      </header>
      <div class="body">
        <div class="row">
          <label for="linkedService">Servicio</label>
          <select id="linkedService"></select>
        </div>
        <div class="row suggestion-source">
          <label for="linkedEmail">Correo</label>
          <input id="linkedEmail" type="email" placeholder="correo@ejemplo.com" autocomplete="off" aria-expanded="false" aria-controls="linkedEmailDropdown">
          <button class="email-toggle" id="linkedEmailDropdownToggle" type="button" aria-label="Mostrar correos guardados">‚ñæ</button>
          <div id="linkedEmailDropdown" class="suggestion-dropdown" role="listbox" aria-hidden="true"></div>
        </div>
        <div class="row">
          <label for="linkedPassword">Contrase√±a</label>
          <div class="pin-wrap">
            <input id="linkedPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off">
            <button type="button" class="eye" id="toggleLinkedPassword" aria-label="Mostrar/ocultar contrase√±a">üëÅ</button>
          </div>
        </div>
        <div class="small" id="linkedError" style="color:var(--danger)"></div>
        <div class="actions" style="justify-content:flex-end">
          <button class="btn ghost" id="btnLinkedDelete" type="button" aria-label="Eliminar correo enlazado">Eliminar</button>
          <button class="btn primary" id="btnLinkedSave" type="button">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<script>
/* ====== CONFIG Supabase ====== */
const SUPABASE_URL = 'https://dlumywskboedejmeejvp.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRsdW15d3NrYm9lZGVqbWVlanZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0Nzk0ODMsImV4cCI6MjA3NDA1NTQ4M30.Ty7b0T6qVneREsH8vKObhpXm5d6wbfXRkA2cFeMzphA';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== helpers y refs ===== */
const $=s=>document.querySelector(s);
const tbody=$('#tabla tbody');
const f={nombre:$('#nombre'),email:$('#email'),telefono:$('#telefono'),
servicio:$('#servicio'),inicio:$('#inicio'),vence:$('#vence'),notas:$('#notas'),
categoria:$('#categoria'), pin:$('#pin')};
const q=$('#q'), filterEstado=$('#filterEstado'), msg=$('#msg');
const sidebar=document.getElementById('sidebar');
const sidebarLauncher=document.getElementById('sidebarLauncher');
const hero=document.getElementById('Hero');
const scrollFadeTargets=['Hero','Registro','TablaClientes'].map(id=>document.getElementById(id)).filter(Boolean);
const docEl=document.documentElement;
const supportsIntersectionObserver='IntersectionObserver'in window;
let heroFadeDistance=1;
let lastHeroFade=null;
let lastHeroInlineFade=null;

function computeHeroFadeDistance(){
  if(!hero) return Math.max((window.innerHeight||docEl.clientHeight||1)*.6,160);
  const rect=hero.getBoundingClientRect();
  const height=Math.max(rect.height||0,hero.offsetHeight||0,1);
  return Math.max(height*1.2,180);
}
function setSectionVisibility(el,visible){
  if(!el) return;
  el.classList.toggle('is-visible',visible);
  el.classList.toggle('is-hidden',!visible);
  if(el===hero && !visible){
    hero.style.opacity='';
    hero.style.filter='';
    hero.style.transform='';
    lastHeroInlineFade=null;
  }
}
let legacyRevealCheck=null;
if(supportsIntersectionObserver&&typeof IntersectionObserver==='function'){
  const observer=new IntersectionObserver(entries=>{
    entries.forEach(entry=> setSectionVisibility(entry.target,entry.isIntersecting));
  },{threshold:.2,rootMargin:'0px 0px -10% 0px'});
  scrollFadeTargets.forEach(el=>observer.observe(el));
}else if(scrollFadeTargets.length){
  legacyRevealCheck=()=>{
    const viewportHeight=window.innerHeight||docEl.clientHeight||0;
    const upper=viewportHeight*.15;
    const lower=viewportHeight*.9;
    scrollFadeTargets.forEach(el=>{
      const rect=el.getBoundingClientRect();
      const visible=rect.bottom>upper && rect.top<lower;
      setSectionVisibility(el,visible);
    });
  };
}
function applyHeroFade(){
  if(!hero){
    docEl.style.setProperty('--hero-fade','1');
    return;
  }
  const distance=heroFadeDistance||1;
  const scrollTop=window.scrollY!=null?window.scrollY:(window.pageYOffset||0);
  const fadeValue=Math.max(0,Math.min(1,1-(scrollTop/distance)));
  const fadeRounded=Math.round(fadeValue*1000)/1000;
  if(lastHeroFade!==fadeRounded){
    docEl.style.setProperty('--hero-fade',fadeRounded.toString());
    lastHeroFade=fadeRounded;
  }
  if(!document.body.classList.contains('page-loaded')){
    lastHeroInlineFade=null;
    return;
  }
  if(lastHeroInlineFade===fadeRounded) return;
  hero.style.opacity=fadeRounded.toString();
  const blur=Math.max(0,(1-fadeRounded)*8);
  hero.style.filter=fadeRounded>=.999?'none':`blur(${blur.toFixed(2)}px)`;
  const offset=Math.max(0,(1-fadeRounded)*24);
  hero.style.transform=fadeRounded>=.999?'none':`translateY(${offset.toFixed(1)}px)`;
  lastHeroInlineFade=fadeRounded;
}
function handleScrollEffects(){
  applyHeroFade();
  if(legacyRevealCheck) legacyRevealCheck();
}
function recalcHeroFadeDistance(){
  heroFadeDistance=computeHeroFadeDistance();
}
recalcHeroFadeDistance();
handleScrollEffects();
window.addEventListener('scroll',handleScrollEffects,{passive:true});
window.addEventListener('resize',()=>{recalcHeroFadeDistance();handleScrollEffects();});
window.addEventListener('load',()=>{
  recalcHeroFadeDistance();
  handleScrollEffects();
  if(typeof requestAnimationFrame==='function'){requestAnimationFrame(handleScrollEffects);}else{setTimeout(handleScrollEffects,0);}
});

const themeButton=document.getElementById('btnTheme');
const themeLabel=document.getElementById('themeLabel');
const themeMenu=document.getElementById('themeMenu');
const themeOptions=Array.from(themeMenu?.querySelectorAll('[data-theme-option]')||[]);
const THEME_STORAGE_KEY='ui_theme_mode_v1';

let editId=null;

/* ===== Dropdown EMAIL (form principal) ===== */
const emailSuggestionDropdown = document.getElementById('emailSuggestionDropdown');
const emailDropdownToggle = document.getElementById('emailDropdownToggle');
let emailSuggestionCache=[];
let filteredEmailSuggestions=[];
let activeEmailSuggestionIndex=-1;
let hideEmailSuggestionTimeout=null;

/* ===== Dropdown EMAIL (modal enlazados) ===== */
const linkedModal = document.getElementById('linkedModal');
const btnLinkedOpen = document.getElementById('btnLinkedOpen');
const btnLinkedHeaderClose = document.getElementById('btnLinkedHeaderClose');
const btnLinkedSave = document.getElementById('btnLinkedSave');
const btnLinkedDelete = document.getElementById('btnLinkedDelete');
const linkedServiceEl = document.getElementById('linkedService');
const linkedEmailEl = document.getElementById('linkedEmail');
const linkedPasswordEl = document.getElementById('linkedPassword');
const toggleLinkedPassword = document.getElementById('toggleLinkedPassword');
const linkedErrorEl = document.getElementById('linkedError');
const linkedEmailDropdown = document.getElementById('linkedEmailDropdown');
const linkedEmailDropdownToggle = document.getElementById('linkedEmailDropdownToggle');

let linkedFilteredSuggestions=[];
let linkedActiveIndex=-1;
let linkedHideTimeout=null;

function toast(t){ msg.textContent=t; setTimeout(()=>msg.textContent='',2200); }
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;' }[m]))}
function renderMarkdown(input){
  const safe = esc(input==null? '' : String(input));
  if(!safe) return '';
  const applyInline = (str)=>{
    if(!str) return '';
    let res = str;
    res = res.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
    res = res.replace(/(^|[\s.,;:!?()"'¬ø¬°-])_(.+?)_(?=[\s.,;:!?()"'¬ø¬°-]|$)/g,(match,prefix,content)=>`${prefix}<em>${content}</em>`);
    return res;
  };
  const parseTableCells = (line,{allowEmpty=false}={})=>{
    if(!line) return null;
    const trimmed = line.trim();
    if(!trimmed.startsWith('|') || !trimmed.endsWith('|')) return null;
    const parts = trimmed.slice(1,-1).split('|').map(cell=>cell.trim());
    if(!parts.length) return null;
    if(!allowEmpty && !parts.some(cell=>cell.length>0)) return null;
    return parts;
  };
  const parseSeparatorLine = (line)=>{
    const cells = parseTableCells(line,{allowEmpty:true});
    if(!cells) return null;
    const isValid = cells.every(cell=>{
      const normalized = cell.replace(/\s+/g,'');
      return /^:?-{3,}:?$/.test(normalized);
    });
    return isValid ? cells : null;
  };
  const lines = safe.split(/\r?\n/);
  const blocks = [];
  let paragraphLines=[];
  let listType=null;
  let listItems=[];
  const flushParagraph=()=>{
    if(!paragraphLines.length) return;
    const text = paragraphLines.join(' ');
    blocks.push(`<p>${text}</p>`);
    paragraphLines=[];
  };
  const flushList=()=>{
    if(!listType || !listItems.length){ listType=null; listItems=[]; return; }
    blocks.push(`<${listType}>${listItems.map(item=>`<li>${item}</li>`).join('')}</${listType}>`);
    listType=null;
    listItems=[];
  };
  for(let i=0;i<lines.length;i++){
    const rawLine = lines[i];
    const trimmed = rawLine.trim();
    if(!trimmed){ flushParagraph(); flushList(); continue; }
    const headerCells = parseTableCells(trimmed);
    if(headerCells && !parseSeparatorLine(trimmed)){
      const separatorLine = lines[i+1]?.trim();
      const separatorCells = parseSeparatorLine(separatorLine);
      if(separatorCells && separatorCells.length === headerCells.length){
        flushParagraph();
        flushList();
        const bodyRows=[];
        let rowIndex=i+2;
        while(rowIndex<lines.length){
          const candidate = lines[rowIndex].trim();
          if(!candidate) break;
          const rowCells = parseTableCells(candidate,{allowEmpty:true});
          if(!rowCells || rowCells.length !== headerCells.length) break;
          bodyRows.push(rowCells);
          rowIndex++;
        }
        const headerHtml = headerCells.map(cell=>`<th>${applyInline(cell)}</th>`).join('');
        const bodyHtml = bodyRows.map(row=>`<tr>${row.map(cell=>`<td>${applyInline(cell)}</td>`).join('')}</tr>`).join('');
        blocks.push(`<table><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`);
        i = rowIndex-1;
        continue;
      }
    }
    const unordered = trimmed.match(/^([-*])\s+(.+)/);
    if(unordered){
      flushParagraph();
      const item = applyInline(unordered[2].trim());
      if(listType!=='ul'){ flushList(); listType='ul'; }
      listItems.push(item);
      continue;
    }
    const ordered = trimmed.match(/^(\d+)[.)]\s+(.+)/);
    if(ordered){
      flushParagraph();
      const item = applyInline(ordered[2].trim());
      if(listType!=='ol'){ flushList(); listType='ol'; }
      listItems.push(item);
      continue;
    }
    flushList();
    paragraphLines.push(applyInline(trimmed));
  }
  flushParagraph();
  flushList();
  return blocks.join('');
}
function fmt(iso){return iso? new Date(iso+'T00:00:00').toLocaleDateString(): '-'}

/* ===== Tema ===== */
function updateThemeControls(mode){
  if(themeLabel){ themeLabel.textContent = mode==='light' ? 'Claro' : 'Oscuro'; }
  themeOptions.forEach(btn=>{
    const isActive = btn.dataset.themeOption === mode;
    btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
  });
}
function applyTheme(mode,{persist=true}={}){
  const normalized = mode==='light' ? 'light' : 'dark';
  document.body.classList.toggle('theme-light', normalized==='light');
  if(persist){ try{ localStorage.setItem(THEME_STORAGE_KEY, normalized); }catch{} }
  updateThemeControls(normalized);
  return normalized;
}
const storedTheme = (()=>{ try{ return localStorage.getItem(THEME_STORAGE_KEY); }catch{ return null; } })();
const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
applyTheme(storedTheme==='light'?'light':(storedTheme==='dark'?'dark':(prefersDark?'dark':'light')),{persist:false});

/* ===== sidebar responsive ===== */
const sidebarMobileQuery=window.matchMedia? window.matchMedia('(max-width: 768px)') : { matches:false };
function isMobileSidebar(){ return sidebarMobileQuery.matches; }
function syncSidebarResponsiveState(){
  if(!sidebar) return;
  const pinned = sidebar.dataset.pinned === 'true';
  sidebar.classList.toggle('pinned', pinned);
  const isVisible = pinned || (!isMobileSidebar() && sidebar.classList.contains('peek'));
  sidebar.setAttribute('aria-hidden', isVisible ? 'false' : 'true');
  sidebarLauncher?.setAttribute('aria-expanded', pinned ? 'true' : 'false');
  sidebarLauncher.textContent = pinned ? '‚úï' : '‚ò∞';
  sidebarLauncher.setAttribute('aria-label', pinned ? 'Cerrar navegaci√≥n' : 'Abrir navegaci√≥n');
  sidebarLauncher.classList.toggle('is-open', pinned);
  if(isMobileSidebar()){
    document.body.classList.remove('sidebar-expanded');
  }else{
    document.body.classList.toggle('sidebar-expanded', pinned);
  }
}
function setSidebarPinned(pinned){
  if(!sidebar) return;
  sidebar.dataset.pinned = String(pinned);
  if(!pinned){ sidebar.classList.remove('peek'); }
  syncSidebarResponsiveState();
}
function expandSidebarIfNeeded(){
  if(!sidebar || isMobileSidebar()) return;
  if(sidebar.dataset.pinned === 'true') return;
  sidebar.classList.add('peek'); sidebar.setAttribute('aria-hidden','false');
}
function collapseSidebarIfNeeded(){
  if(!sidebar) return;
  if(sidebar.dataset.pinned === 'true') return;
  sidebar.classList.remove('peek'); sidebar.setAttribute('aria-hidden','true');
}
syncSidebarResponsiveState();
sidebarLauncher?.addEventListener('click', ()=> setSidebarPinned(sidebar.dataset.pinned !== 'true'));
sidebar?.addEventListener('mouseenter', expandSidebarIfNeeded);
sidebar?.addEventListener('mouseleave', collapseSidebarIfNeeded);
sidebar?.addEventListener('focusin', expandSidebarIfNeeded);
sidebar?.addEventListener('focusout', (e)=>{ if(!sidebar.contains(e.relatedTarget)) collapseSidebarIfNeeded(); });
if(sidebarMobileQuery.addEventListener){ sidebarMobileQuery.addEventListener('change', ()=>{ syncSidebarResponsiveState(); collapseSidebarIfNeeded(); }); }

/* ===== fechas & estado ===== */
function diasRestantes(iso){
  if(!iso) return null; const h=new Date();h.setHours(0,0,0,0);
  const d=new Date(iso); d.setHours(0,0,0,0);
  return Math.round((d-h)/(1000*60*60*24));
}
function estadoDe(vence){
  if(!vence) return ''; const d=diasRestantes(vence);
  if(d<0) return 'vencida'; if(d<=7) return 'pronto'; return 'vigente';
}
function limpiar(){
  editId=null;
  for(const k in f){ if('value' in f[k]) f[k].value=''; }
  Promise.resolve(renderServicios()).then(()=>{
    rebuildEmailSuggestions();
    handleEmailSuggestionSelection();
  });
  msg.textContent='';
}

/* ===== Linked accounts base ===== */
function normalize(t){return (t||'').toString().normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'').toLowerCase();}
function linkedServiceKey(servicio){ return normalize((servicio||'').toString().trim()); }
function linkedEmailKey(email){ return (email||'').toString().trim().toLowerCase(); }
function linkedCompositeKey(servicio,email){
  const s=linkedServiceKey(servicio), e=linkedEmailKey(email);
  return s&&e? `${s}::${e}`:'';
}
const LINKED_ACCOUNTS_KEY = 'linked_accounts_v1';
function loadStoredLinkedAccounts(){
  try{
    const raw=localStorage.getItem(LINKED_ACCOUNTS_KEY); if(!raw) return [];
    const arr=JSON.parse(raw)||[];
    const seen=new Set(); const out=[];
    arr.forEach(it=>{
      const rec={ servicio:String(it.servicio||'').trim(), email:String(it.email||'').trim(), password:String(it.password||'') };
      if(!rec.servicio||!rec.email||!rec.password) return;
      const key=linkedCompositeKey(rec.servicio,rec.email);
      if(seen.has(key)) return; seen.add(key); out.push(rec);
    });
    out.sort((a,b)=> a.servicio.localeCompare(b.servicio)||a.email.localeCompare(b.email));
    return out;
  }catch{ return []; }
}
function saveLinkedAccounts(arr){
  try{
    const seen=new Set(); const clean=(Array.isArray(arr)?arr:[]).map(it=>({servicio:String(it.servicio||'').trim(),email:String(it.email||'').trim(),password:String(it.password||'')}))
      .filter(it=>it.servicio&&it.email&&it.password)
      .filter(it=>{const k=linkedCompositeKey(it.servicio,it.email); if(seen.has(k)) return false; seen.add(k); return true;})
      .sort((a,b)=> a.servicio.localeCompare(b.servicio)||a.email.localeCompare(b.email));
    localStorage.setItem(LINKED_ACCOUNTS_KEY, JSON.stringify(clean));
    return clean.slice();
  }catch{ return loadStoredLinkedAccounts(); }
}
let linkedAccounts = loadStoredLinkedAccounts();

/* index por servicio/email para consultas r√°pidas */
let linkedAccountsIndex = new Map();
function linkedIndexFrom(records){
  const idx=new Map();
  (records||[]).forEach(rec=>{
    const s=linkedServiceKey(rec.servicio), e=linkedEmailKey(rec.email);
    if(!s||!e) return;
    if(!idx.has(s)) idx.set(s,new Map());
    idx.get(s).set(e,{ ...rec });
  });
  return idx;
}
function updateLinkedAccountsFrom(records){
  linkedAccountsIndex = linkedIndexFrom(records);
  rebuildEmailSuggestions(); // actualiza principal
}
updateLinkedAccountsFrom(linkedAccounts);

function getLinkedAccountsByService(servicio){
  const bucket = linkedAccountsIndex.get(linkedServiceKey(servicio||'')); if(!bucket) return [];
  return Array.from(bucket.values()).map(v=>({ ...v }));
}
function findLinkedAccount(servicio,email){
  const b=linkedAccountsIndex.get(linkedServiceKey(servicio||'')); if(!b) return null;
  const v=b.get(linkedEmailKey(email)); return v? { ...v }:null;
}

/* ====== Semillas / almacenamiento local de servicios (fallback si no hay sesi√≥n) ====== */
const defaultServices = ["ChatGPT","Gemini","YouTube","Disney"];
let localServices = JSON.parse(localStorage.getItem('services_local') || 'null');
if (!Array.isArray(localServices) || !localServices.length) {
  localServices = defaultServices.slice();
  localStorage.setItem('services_local', JSON.stringify(localServices));
}
function saveLocalServices() {
  localServices = Array.from(new Set(localServices)).filter(Boolean).sort((a,b)=>a.localeCompare(b));
  localStorage.setItem('services_local', JSON.stringify(localServices));
}

/* ===== clientes locales ===== */
const LOCAL_CLIENTS_KEY = 'clients_local_v1';
function loadLocalClients(){
  try{
    const raw=localStorage.getItem(LOCAL_CLIENTS_KEY); if(!raw) return [];
    const arr=JSON.parse(raw)||[];
    arr.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''));
    return arr;
  }catch{ return []; }
}
let localClients = loadLocalClients();
function saveLocalClients(){
  try{
    localStorage.setItem(LOCAL_CLIENTS_KEY, JSON.stringify(localClients.slice().sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||''))));
  }catch{}
}

/* ====== AUTH (Supabase) ====== */
let currentUser = null;
sb.auth.onAuthStateChange((_e, session)=>{
  currentUser = session?.user || null;
  authUpdateUI();
  syncLocalServicesToCloudIfEmpty().finally(()=>{
    renderServicios().then(renderTabla);
  });
});
function authUpdateUI(){
  const badge = document.getElementById('userInfo');
  const btnAuthOpen = document.getElementById('btnAuthOpen');
  const btnLogout = document.getElementById('btnLogout');
  if(currentUser){
    badge.style.display='inline-block';
    badge.textContent = currentUser.email;
    btnAuthOpen.style.display='none';
    btnLogout.style.display='inline-block';
  }else{
    badge.style.display='none';
    btnAuthOpen.style.display='inline-block';
    btnLogout.style.display='none';
  }
}
const authModal    = document.getElementById('authModal');
const btnAuthOpen  = document.getElementById('btnAuthOpen');
const btnAuthClose = document.getElementById('btnAuthClose');
const btnAuthSubmit= document.getElementById('btnAuthSubmit');
const authEmailEl  = document.getElementById('authEmail');
const authPassEl   = document.getElementById('authPass');
const authErrorEl  = document.getElementById('authError');
const toggleAuthPass = document.getElementById('toggleAuthPass');
const btnForgot    = document.getElementById('btnForgot');

function openAuth(){ authErrorEl.textContent=''; authErrorEl.style.color='var(--danger)'; authModal.classList.add('open'); authModal.setAttribute('aria-hidden','false'); setTimeout(()=>authEmailEl?.focus(), 0); }
function closeAuth(){ authModal.classList.remove('open'); authModal.setAttribute('aria-hidden','true'); }
btnAuthOpen?.addEventListener('click', openAuth);
btnAuthClose?.addEventListener('click', closeAuth);
authModal?.addEventListener('click', (e)=>{ if(e.target===authModal) closeAuth(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAuth(); });

toggleAuthPass?.addEventListener('click', ()=>{
  const isPass = authPassEl.type==='password';
  authPassEl.type = isPass? 'text':'password';
  toggleAuthPass.textContent = isPass? 'üôà':'üëÅ';
});

// sign-in/up unificado
async function autoSignInOrUp(email, password) {
  let { error } = await sb.auth.signInWithPassword({ email, password });
  if (!error) return { ok: true };
  const { data, error: eUp } = await sb.auth.signUp({ email, password });
  if (eUp) return { ok: false, message: eUp.message };
  if (!data.session) {
    const { error: eIn2 } = await sb.auth.signInWithPassword({ email, password });
    if (eIn2) return { ok: false, message: eIn2.message };
  }
  return { ok: true };
}
btnAuthSubmit?.addEventListener('click', async () => {
  const email = (authEmailEl.value || '').trim();
  const pass  = (authPassEl.value || '').trim();
  authErrorEl.textContent = ''; authErrorEl.style.color = 'var(--danger)';
  if (!email || !pass) { authErrorEl.textContent = 'Completa correo y contrase√±a.'; return; }
  btnAuthSubmit.disabled = true; btnAuthSubmit.textContent = 'Procesando‚Ä¶';
  try{
    const r = await autoSignInOrUp(email, pass);
    if (!r.ok) authErrorEl.textContent = r.message || 'No se pudo acceder.';
    else { closeAuth(); toast('¬°Bienvenido!'); }
  }catch(err){ authErrorEl.textContent = err.message || 'Error inesperado.'; }
  finally{ btnAuthSubmit.disabled = false; btnAuthSubmit.textContent = 'Continuar'; }
});
document.getElementById('btnLogout')?.addEventListener('click', async ()=>{ await sb.auth.signOut(); });

// reset pass
btnForgot?.addEventListener('click', async ()=>{
  const email = (authEmailEl.value||'').trim();
  authErrorEl.style.color = 'var(--danger)'; authErrorEl.textContent = '';
  if(!email){ authErrorEl.textContent = 'Escribe tu correo arriba para enviarte el enlace.'; return; }
  const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo: location.origin + location.pathname });
  if(error){ authErrorEl.textContent = error.message || 'No se pudo enviar el correo de recuperaci√≥n.'; return; }
  authErrorEl.style.color = 'var(--success)'; authErrorEl.textContent = 'Te enviamos un correo para restablecer tu contrase√±a.';
});

/* ====== DB en la nube (Supabase) ====== */
let cacheClientes = localClients.slice();
let cacheServicios = [];
const db = {
  getAll(){ return currentUser ? cacheClientes.slice() : localClients.slice(); },
  async fetchAll(){
    if(!currentUser){
      localClients = loadLocalClients();
      cacheClientes = localClients.slice();
      return cacheClientes.slice();
    }
    const { data, error } = await sb.from('clients').select('*').eq('user_id', currentUser.id).order('nombre', { ascending:true });
    if(error){ console.error(error); cacheClientes=[]; return cacheClientes; }
    cacheClientes = data||[]; return cacheClientes.slice();
  },
  async saveOne(rec){
    if(!currentUser){
      localClients = loadLocalClients();
      const recId = rec.id ?? crypto.randomUUID();
      const idx = localClients.findIndex(x=>x.id===recId);
      const payload = { ...(idx>=0? localClients[idx]:{}), ...rec, id: recId };
      if(idx>=0) localClients[idx] = payload; else localClients.push(payload);
      localClients.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'')); saveLocalClients();
      cacheClientes = localClients.slice(); return payload;
    }
    const rowNoId = {
      user_id: currentUser.id,
      nombre:rec.nombre, email:rec.email, telefono:rec.telefono, servicio:rec.servicio,
      inicio:rec.inicio, vence:rec.vence, categoria:rec.categoria, notas:rec.notas, pin:rec.pin, ts:rec.ts
    };
    let data, error; const hasId = rec.id!==undefined && rec.id!==null && `${rec.id}`.trim()!=='';
    if (!hasId) ({ data, error } = await sb.from('clients').insert(rowNoId).select().single());
    else {
      ({ data, error } = await sb.from('clients').update(rowNoId).eq('id', rec.id).select().single());
      if (error) ({ data, error } = await sb.from('clients').upsert({ ...rowNoId, id: rec.id }, { onConflict: 'id' }).select().single());
    }
    if (error) throw error;
    const i = cacheClientes.findIndex(x=>x.id===data.id);
    if(i>=0) cacheClientes[i]=data; else cacheClientes.push(data);
    cacheClientes.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'')); return data;
  },
  async deleteOne(id){
    if(!currentUser){
      localClients = loadLocalClients().filter(x=>x && x.id!==id); saveLocalClients(); cacheClientes = localClients.slice(); return;
    }
    const { error } = await sb.from('clients').delete().eq('id', id);
    if(error) throw error; cacheClientes = cacheClientes.filter(x=>x.id!==id);
  },
  async saveAll(arr){
    if(!currentUser){
      localClients = arr.map(x=>({ ...x })); localClients.sort((a,b)=> (a.nombre||'').localeCompare(b.nombre||'')); saveLocalClients(); cacheClientes = localClients.slice(); return;
    }
    const rows = arr.map(x=>({ ...x, user_id: currentUser.id }));
    const { error } = await sb.from('clients').upsert(rows, { onConflict:'id' });
    if(error) throw error; cacheClientes = arr.slice();
  },
  getServicios(){ return currentUser ? cacheServicios.slice() : localServices.slice(); },
  async fetchServicios(){
    if (!currentUser) return localServices.slice();
    const { data, error } = await sb.from('services').select('name').eq('user_id', currentUser.id).order('name');
    if(error){ console.error(error); cacheServicios = []; return []; }
    cacheServicios = (data||[]).map(x=>x.name); return cacheServicios.slice();
  },
  async replaceServicios(list){
    if (!currentUser) { localServices = list.slice(); saveLocalServices(); return; }
    const { data: curr } = await sb.from('services').select('name').eq('user_id', currentUser.id);
    const has = new Set((curr||[]).map(x=>x.name)); const want = new Set(list);
    const toDel = [...has].filter(n=>!want.has(n)); if (toDel.length) await sb.from('services').delete().in('name', toDel).eq('user_id', currentUser.id);
    const toIns = [...want].filter(n=>!has.has(n)).map(n=>({ user_id: currentUser.id, name:n })); if (toIns.length) await sb.from('services').insert(toIns);
    cacheServicios = list.slice();
  }
};
async function syncLocalServicesToCloudIfEmpty(){
  if (!currentUser) return;
  const cloud = await db.fetchServicios();
  if (cloud.length === 0 && localServices.length) { await db.replaceServicios(localServices); localStorage.removeItem('services_local'); }
}

/* ====== UI din√°mica ====== */
async function renderServicios(sel){
  const list = await db.fetchServicios();
  const final = list.length ? list : defaultServices;
  f.servicio.innerHTML = final.map(s=>`<option value="${s}">${s}</option>`).join('');
  if(sel && final.includes(sel)) f.servicio.value=sel; else if(final.length) f.servicio.value=final[0]; else f.servicio.value='';
  rebuildEmailSuggestions();
  handleEmailSuggestionSelection();
}
async function renderTabla(){
  const arr = await db.fetchAll();
  const items=arr.filter(x=>coincide(x,q?.value)&&pasaEstado(x,filterEstado?.value))
                 .sort((a,b)=> (diasRestantes(a.vence)??1e9) - (diasRestantes(b.vence)??1e9));
  tbody.innerHTML=items.map(x=>{
    const d=diasRestantes(x.vence); const est=estadoDe(x.vence);
    const tag=est==='vigente'?'ok':est==='pronto'?'warn':'bad';
    const estTxt=est?est[0].toUpperCase()+est.slice(1):'-';
    const diasTxt= d==null?'-':(d<0?`Vencido ${Math.abs(d)} d`:`Faltan ${d} d`);
    return `<tr class="has-row-menu" tabindex="0" aria-haspopup="menu" aria-expanded="false">
      <td data-label="Nombre">${esc(x.nombre)}</td>
      <td data-label="Email">${esc(x.email||'')}</td>
      <td data-label="Servicio">${esc(x.servicio||'')}</td>
      <td data-label="Inicio">${fmt(x.inicio)}</td>
      <td data-label="Vence">${fmt(x.vence)}</td>
      <td data-label="Estado">${est?`<span class="tag ${tag}">${estTxt}</span>`:'-'}</td>
      <td data-label="D√≠as">${diasTxt}</td>
      <td data-label="Acciones" class="cell-actions">
        <div class="menu-wrap">
          <div class="row-menu-indicator" aria-hidden="true"><span class="dots">‚ãØ</span></div>
          <div class="menu" role="menu" aria-hidden="true">
            <button class="menu-item" role="menuitem" data-action="edit" data-id="${x.id}">‚úé Editar</button>
            <button class="menu-item" role="menuitem" data-action="label" data-id="${x.id}">üè∑ Etiqueta</button>
            <button class="menu-item danger" role="menuitem" data-action="delete" data-id="${x.id}">üóë Eliminar</button>
          </div>
        </div>
      </td>
    </tr>`;
  }).join('');
}
function coincide(x,qq){
  qq=(qq||'').trim().toLowerCase(); if(!qq) return true;
  return [x.nombre,x.email,x.servicio,x.telefono,x.categoria,x.notas].some(v=>(v||'').toLowerCase().includes(qq));
}
function pasaEstado(x,f){ if(!f) return true; return estadoDe(x.vence)===f; }

$('#btnLimpiar').onclick=limpiar;

/* ===== EMAIL dropdown (principal) ===== */
function rebuildEmailSuggestions(){
  emailSuggestionCache = getLinkedAccountsByService(f.servicio?.value||'');
}
function isEmailSuggestionDropdownOpen(){ return emailSuggestionDropdown?.classList.contains('open'); }
function hideEmailSuggestionDropdown(){
  if(!emailSuggestionDropdown) return;
  emailSuggestionDropdown.classList.remove('open');
  emailSuggestionDropdown.setAttribute('aria-hidden','true');
  f.email?.setAttribute('aria-expanded','false');
  if(emailDropdownToggle) emailDropdownToggle.setAttribute('aria-expanded','false');
  emailSuggestionDropdown.innerHTML=''; filteredEmailSuggestions=[]; activeEmailSuggestionIndex=-1;
  if(hideEmailSuggestionTimeout){ clearTimeout(hideEmailSuggestionTimeout); hideEmailSuggestionTimeout=null; }
}
function updateEmailSuggestionDropdown(filterText){
  if(!emailSuggestionDropdown) return;
  const term = typeof filterText==='string'? filterText.trim().toLowerCase() : (f.email?.value||'').trim().toLowerCase();
  filteredEmailSuggestions = (emailSuggestionCache||[]).filter(item=> !term || item.email.toLowerCase().includes(term));

  if(!filteredEmailSuggestions.length){
    emailSuggestionDropdown.innerHTML=`<div class="suggestion-empty">${esc(term ? 'Sin coincidencias' : 'Sin correos enlazados')}</div>`;
  }else{
    emailSuggestionDropdown.innerHTML = filteredEmailSuggestions.map((item,idx)=>{
      const hint=item.password? '<span class="suggestion-hint">Contrase√±a guardada</span>':'';
      return `<button type="button" class="suggestion-item" data-index="${idx}" role="option" id="emailopt-${idx}">
                <span class="suggestion-email">${esc(item.email)}</span>${hint}
              </button>`;
    }).join('');
    Array.from(emailSuggestionDropdown.querySelectorAll('.suggestion-item')).forEach(btn=>{
      btn.addEventListener('mousedown',e=>e.preventDefault());
      btn.addEventListener('click',()=> selectEmailSuggestion(Number(btn.dataset.index)));
    });
  }
  emailSuggestionDropdown.classList.add('open');
  emailSuggestionDropdown.setAttribute('aria-hidden','false');
  f.email?.setAttribute('aria-expanded','true');
  if(emailDropdownToggle) emailDropdownToggle.setAttribute('aria-expanded','true');
  activeEmailSuggestionIndex=-1;
}
function highlightEmailSuggestion(idx){
  if(!emailSuggestionDropdown) return;
  const items=Array.from(emailSuggestionDropdown.querySelectorAll('.suggestion-item'));
  items.forEach((el,i)=>{ el.classList.toggle('is-active', i===idx); if(i===idx){ el.setAttribute('aria-selected','true'); f.email?.setAttribute('aria-activedescendant', el.id); } else { el.removeAttribute('aria-selected'); }});
  if(idx>=0 && items[idx]) items[idx].scrollIntoView({ block:'nearest' });
}
function moveEmailSuggestion(delta){
  if(!filteredEmailSuggestions.length){ updateEmailSuggestionDropdown(); if(!filteredEmailSuggestions.length) return; }
  if(!isEmailSuggestionDropdownOpen()) updateEmailSuggestionDropdown();
  activeEmailSuggestionIndex=(activeEmailSuggestionIndex+delta+filteredEmailSuggestions.length)%filteredEmailSuggestions.length;
  highlightEmailSuggestion(activeEmailSuggestionIndex);
}
function selectEmailSuggestion(idx){
  const account=filteredEmailSuggestions[idx]; if(!account) return;
  if(f.email) f.email.value=account.email;
  applyLinkedAccount(account);
  handleEmailSuggestionSelection();
  hideEmailSuggestionDropdown();
}
function showEmailSuggestions(){
  rebuildEmailSuggestions();
  updateEmailSuggestionDropdown(f.email.value);
}
function applyLinkedAccount(account){
  if(!account) return;
  if(account.password && f.pin && (!f.pin.value||f.pin.value.trim()==='')) f.pin.value=account.password;
}

/* eventos principal */
if(f.servicio){ ['change','input'].forEach(evt=> f.servicio.addEventListener(evt, ()=>{
  rebuildEmailSuggestions(); handleEmailSuggestionSelection();
  if(document.activeElement===f.email) showEmailSuggestions(); else hideEmailSuggestionDropdown();
}));}
if(f.email){
  f.email.addEventListener('focus',()=>{ showEmailSuggestions(); });
  f.email.addEventListener('click',()=>{ showEmailSuggestions(); });
  f.email.addEventListener('input',()=>{ updateEmailSuggestionDropdown(f.email.value); handleEmailSuggestionSelection(); });
  f.email.addEventListener('change',()=>{ handleEmailSuggestionSelection(); });
  f.email.addEventListener('keydown',(e)=>{
    if(e.key==='ArrowDown'){ e.preventDefault(); moveEmailSuggestion(1); }
    else if(e.key==='ArrowUp'){ if(isEmailSuggestionDropdownOpen()){ e.preventDefault(); moveEmailSuggestion(-1); } }
    else if(e.key==='Enter'){ if(isEmailSuggestionDropdownOpen() && activeEmailSuggestionIndex>=0){ e.preventDefault(); selectEmailSuggestion(activeEmailSuggestionIndex); } }
    else if(e.key==='Escape'){ if(isEmailSuggestionDropdownOpen()){ e.preventDefault(); hideEmailSuggestionDropdown(); } }
  });
  f.email.addEventListener('blur',()=>{ hideEmailSuggestionTimeout=setTimeout(()=>hideEmailSuggestionDropdown(),120); });
}
emailSuggestionDropdown?.addEventListener('mouseenter',()=>{ if(hideEmailSuggestionTimeout){ clearTimeout(hideEmailSuggestionTimeout); hideEmailSuggestionTimeout=null; }});
emailSuggestionDropdown?.addEventListener('mouseleave',()=>{ hideEmailSuggestionTimeout=setTimeout(()=>hideEmailSuggestionDropdown(),120); });
emailDropdownToggle?.addEventListener('click', (e)=>{ e.preventDefault(); if(isEmailSuggestionDropdownOpen()) hideEmailSuggestionDropdown(); else showEmailSuggestions(); });

/* selecci√≥n contextual */
function handleEmailSuggestionSelection(){
  if(!f.email||!f.servicio) return;
  const servicioActual=f.servicio.value;
  const emailActual=(f.email.value||'').trim();
  if(!servicioActual||!emailActual) return;
  const account=findLinkedAccount(servicioActual,emailActual);
  if(account) applyLinkedAccount(account);
}

/* ===== Modal Correos enlazados (dropdown similar) ===== */
function populateLinkedServices(){
  if(!linkedServiceEl) return;
  const previous = linkedServiceEl.value;
  let servicios = [];
  return db.fetchServicios().then(list=>{
    servicios = Array.from(new Set((Array.isArray(list)? list:[]).filter(Boolean).map(String)));
    linkedServiceEl.innerHTML = '';
    if(!servicios.length){
      const option = document.createElement('option'); option.value=''; option.textContent='No hay servicios disponibles'; option.disabled=true; option.selected=true;
      linkedServiceEl.appendChild(option); linkedServiceEl.disabled=true;
      linkedEmailEl.value=''; linkedEmailEl.disabled=true; linkedPasswordEl.value=''; linkedPasswordEl.disabled=true;
      btnLinkedSave.disabled = true; btnLinkedDelete.disabled = true; linkedErrorEl.textContent = 'Agrega servicios para enlazar correos.'; return;
    }
    linkedServiceEl.disabled=false; linkedEmailEl.disabled=false; linkedPasswordEl.disabled=false;
    btnLinkedSave.disabled=false; btnLinkedDelete.disabled=true; linkedErrorEl.textContent='';
    const placeholder = document.createElement('option'); placeholder.value=''; placeholder.textContent='Selecciona un servicio'; linkedServiceEl.appendChild(placeholder);
    servicios.forEach(s=>{ const opt=document.createElement('option'); opt.value=s; opt.textContent=s; linkedServiceEl.appendChild(opt); });
    let next = previous && servicios.includes(previous) ? previous : (linkedAccounts.find(it=>servicios.includes(it.servicio))?.servicio || servicios[0] || '');
    if(next) linkedServiceEl.value = next;
    applyLinkedAccountToForm(next);
    refreshLinkedEmailDropdown();
  });
}
function openLinkedModal(){
  if(!linkedModal) return;
  linkedErrorEl.textContent=''; linkedModal.classList.add('open'); linkedModal.setAttribute('aria-hidden','false');
  populateLinkedServices().finally(()=> setTimeout(()=> linkedServiceEl?.focus(),0));
}
function closeLinkedModal(){
  linkedModal.classList.remove('open'); linkedModal.setAttribute('aria-hidden','true');
  if(linkedPasswordEl) linkedPasswordEl.type='password';
}
btnLinkedOpen?.addEventListener('click', openLinkedModal);
btnLinkedHeaderClose?.addEventListener('click', closeLinkedModal);
linkedModal?.addEventListener('click', (e)=>{ if(e.target===linkedModal) closeLinkedModal(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeLinkedModal(); });

function applyLinkedAccountToForm(servicio){
  linkedEmailEl.value=''; linkedPasswordEl.value=''; linkedPasswordEl.type='password'; btnLinkedDelete.disabled=true; refreshLinkedEmailDropdown();
}
function syncLinkedEmailState({resetPassword=true}={}){
  const servicio=linkedServiceEl?.value||''; const email=(linkedEmailEl?.value||'').trim(); const account=servicio&&email? findLinkedAccount(servicio,email):null;
  if(linkedPasswordEl){
    if(account) linkedPasswordEl.value = account.password || ''; else if(resetPassword) linkedPasswordEl.value = '';
    linkedPasswordEl.type='password';
  }
  btnLinkedDelete.disabled = !account;
  return account;
}
toggleLinkedPassword?.addEventListener('click', ()=>{
  const isPass = linkedPasswordEl.type==='password';
  linkedPasswordEl.type = isPass? 'text':'password';
  toggleLinkedPassword.textContent = isPass? 'üôà':'üëÅ';
});
linkedServiceEl?.addEventListener('change', ()=>{ applyLinkedAccountToForm(linkedServiceEl.value); });

/* dropdown enlazados helpers */
function isLinkedDropdownOpen(){ return linkedEmailDropdown?.classList.contains('open'); }
function hideLinkedEmailDropdown(){
  if(!linkedEmailDropdown) return;
  linkedEmailDropdown.classList.remove('open');
  linkedEmailDropdown.setAttribute('aria-hidden','true');
  linkedEmailEl?.setAttribute('aria-expanded','false');
  linkedEmailDropdown.innerHTML=''; linkedFilteredSuggestions=[]; linkedActiveIndex=-1;
  if(linkedHideTimeout){ clearTimeout(linkedHideTimeout); linkedHideTimeout=null; }
}
function refreshLinkedEmailDropdown(){
  const servicioActual = linkedServiceEl?.value || '';
  const cache = getLinkedAccountsByService(servicioActual);
  const term = (linkedEmailEl?.value || '').trim().toLowerCase();
  linkedFilteredSuggestions = cache.filter(item=> !term || item.email.toLowerCase().includes(term));
  if(!linkedEmailDropdown) return;
  if(!linkedFilteredSuggestions.length){
    linkedEmailDropdown.innerHTML=`<div class="suggestion-empty">${esc(term?'Sin coincidencias':'Sin correos enlazados')}</div>`;
  }else{
    linkedEmailDropdown.innerHTML = linkedFilteredSuggestions.map((item,idx)=>{
      const hint=item.password? '<span class="suggestion-hint">Contrase√±a guardada</span>':'';
      return `<button type="button" class="suggestion-item" data-index="${idx}" role="option" id="linkedopt-${idx}">
                <span class="suggestion-email">${esc(item.email)}</span>${hint}
              </button>`;
    }).join('');
    Array.from(linkedEmailDropdown.querySelectorAll('.suggestion-item')).forEach(btn=>{
      btn.addEventListener('mousedown',e=>e.preventDefault());
      btn.addEventListener('click',()=> linkedSelectEmailSuggestion(Number(btn.dataset.index)));
    });
  }
}
function showLinkedEmailDropdown(){
  refreshLinkedEmailDropdown();
  linkedEmailDropdown.classList.add('open');
  linkedEmailDropdown.setAttribute('aria-hidden','false');
  linkedEmailEl?.setAttribute('aria-expanded','true');
  linkedActiveIndex=-1;
}
function linkedHighlight(idx){
  const items=Array.from(linkedEmailDropdown.querySelectorAll('.suggestion-item'));
  items.forEach((el,i)=>{ el.classList.toggle('is-active', i===idx); if(i===idx){ el.setAttribute('aria-selected','true'); linkedEmailEl?.setAttribute('aria-activedescendant', el.id); } else { el.removeAttribute('aria-selected'); } });
  if(idx>=0 && items[idx]) items[idx].scrollIntoView({ block:'nearest' });
}
function linkedMove(delta){
  if(!linkedFilteredSuggestions.length){ refreshLinkedEmailDropdown(); if(!linkedFilteredSuggestions.length) return; }
  if(!isLinkedDropdownOpen()) showLinkedEmailDropdown();
  linkedActiveIndex=(linkedActiveIndex+delta+linkedFilteredSuggestions.length)%linkedFilteredSuggestions.length;
  linkedHighlight(linkedActiveIndex);
}
function linkedSelectEmailSuggestion(idx){
  const account=linkedFilteredSuggestions[idx]; if(!account) return;
  linkedEmailEl.value=account.email;
  const acc = syncLinkedEmailState({ resetPassword:false });
  if(acc?.password && (!linkedPasswordEl.value || linkedPasswordEl.value.trim()==='')) linkedPasswordEl.value = acc.password;
  hideLinkedEmailDropdown();
}

/* eventos modal enlazados */
linkedEmailEl?.addEventListener('focus', showLinkedEmailDropdown);
linkedEmailEl?.addEventListener('click', showLinkedEmailDropdown);
linkedEmailEl?.addEventListener('input', ()=>{ refreshLinkedEmailDropdown(); syncLinkedEmailState({ resetPassword:true }); });
linkedEmailEl?.addEventListener('change', ()=>{ syncLinkedEmailState({ resetPassword:true }); });
linkedEmailEl?.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowDown'){ e.preventDefault(); linkedMove(1); }
  else if(e.key==='ArrowUp'){ if(isLinkedDropdownOpen()){ e.preventDefault(); linkedMove(-1); } }
  else if(e.key==='Enter'){ if(isLinkedDropdownOpen() && linkedActiveIndex>=0){ e.preventDefault(); linkedSelectEmailSuggestion(linkedActiveIndex); } }
  else if(e.key==='Escape'){ if(isLinkedDropdownOpen()){ e.preventDefault(); hideLinkedEmailDropdown(); } }
});
linkedEmailEl?.addEventListener('blur', ()=>{ linkedHideTimeout=setTimeout(()=>hideLinkedEmailDropdown(),120); });
linkedEmailDropdown?.addEventListener('mouseenter', ()=>{ if(linkedHideTimeout){ clearTimeout(linkedHideTimeout); linkedHideTimeout=null; }});
linkedEmailDropdown?.addEventListener('mouseleave', ()=>{ linkedHideTimeout=setTimeout(()=>hideLinkedEmailDropdown(),120); });
linkedEmailDropdownToggle?.addEventListener('click', (e)=>{ e.preventDefault(); if(isLinkedDropdownOpen()) hideLinkedEmailDropdown(); else showLinkedEmailDropdown(); });

btnLinkedSave?.addEventListener('click', ()=>{
  const servicio = linkedServiceEl.value;
  const email = linkedEmailEl.value.trim();
  const password = linkedPasswordEl.value;
  linkedErrorEl.textContent='';
  if(!servicio){ linkedErrorEl.textContent='Selecciona un servicio.'; linkedServiceEl.focus(); return; }
  if(!email){ linkedErrorEl.textContent='Ingresa un correo v√°lido.'; linkedEmailEl.focus(); return; }
  if(!password){ linkedErrorEl.textContent='Ingresa una contrase√±a.'; linkedPasswordEl.focus(); return; }
  const payload={ servicio, email, password };
  const idx = linkedAccounts.findIndex(it=>linkedCompositeKey(it.servicio,it.email)===linkedCompositeKey(servicio,email));
  if(idx>=0) linkedAccounts[idx]=payload; else linkedAccounts.push(payload);
  linkedAccounts = saveLinkedAccounts(linkedAccounts);
  updateLinkedAccountsFrom(linkedAccounts); // actualiza √≠ndice y principal
  toast('Correo enlazado guardado ‚úì'); closeLinkedModal();
});
btnLinkedDelete?.addEventListener('click', ()=>{
  const servicio=linkedServiceEl.value, email=linkedEmailEl.value.trim();
  linkedErrorEl.textContent=''; if(!servicio||!email){ linkedErrorEl.textContent='Selecciona un servicio y correo guardado.'; return; }
  const key=linkedCompositeKey(servicio,email);
  const idx=linkedAccounts.findIndex(it=>linkedCompositeKey(it.servicio,it.email)===key);
  if(idx<0){ toast('No hay correo enlazado para eliminar.'); return; }
  linkedAccounts.splice(idx,1);
  linkedAccounts = saveLinkedAccounts(linkedAccounts);
  updateLinkedAccountsFrom(linkedAccounts);
  linkedEmailEl.value=''; linkedPasswordEl.value=''; btnLinkedDelete.disabled=true;
  refreshLinkedEmailDropdown();
  toast('Correo enlazado eliminado ‚úì');
});

/* ===== Acciones tabla ===== */
$('#btnGuardar').onclick = async ()=>{
  const data={
    nombre:f.nombre.value.trim(), email:f.email.value.trim(), telefono:f.telefono.value.trim(),
    servicio:f.servicio.value, inicio:f.inicio.value, vence:f.vence.value,
    categoria:f.categoria.value, notas:f.notas.value.trim(), pin:f.pin.value.trim(), ts:Date.now()
  };
  if(editId!==null && editId!==undefined) data.id = editId;
  if(!data.nombre){ toast('Escribe un nombre'); return; }
  const wasGuest = !currentUser;
  try{
    await db.saveOne(data); await renderTabla(); limpiar();
    toast(wasGuest && !currentUser ? 'Guardado local ‚úì  Accede para sincronizar' : 'Guardado ‚úì');
  }catch(err){ toast(err?.message || 'No se pudo guardar.'); }
};
function editar(id){
  const x=db.getAll().find(c=>c.id===id); if(!x) return; editId=x.id;
  for(const k in f){ if(k in x) f[k].value=x[k]||''; }
  msg.textContent='Editando‚Ä¶ guarda para aplicar cambios';
}
async function borrar(id){
  if(!confirm('¬øEliminar este cliente?')) return;
  await db.deleteOne(id); await renderTabla();
}

/* Men√∫s (kebab + tema) + cierre fuera de la fila activa */
function getMenuController(menu){
  if(!menu) return null;
  const wrap=menu.closest('.menu-wrap');
  if(wrap){ const control=wrap.querySelector('[aria-haspopup="menu"]'); if(control) return control; }
  return menu.closest('tr.has-row-menu');
}
function setMenuState(menu,isOpen){
  if(!menu) return;
  if(isOpen){ menu.classList.add('open'); menu.setAttribute('aria-hidden','false'); }
  else{ menu.classList.remove('open'); menu.setAttribute('aria-hidden','true'); }
  const controller=getMenuController(menu);
  if(controller){ controller.setAttribute('aria-expanded',isOpen?'true':'false'); }
}
function closeAllMenus(except=null){
  document.querySelectorAll('.menu.open').forEach(menu=>{
    if(except && menu===except) return; setMenuState(menu,false);
  });
}
document.addEventListener('click',(e)=>{
  const wrap=e.target.closest('.menu-wrap');
  const toggle=e.target.closest('[data-menu-toggle]');
  const item=e.target.closest('.menu-item');
  const rowTrigger=e.target.closest('tr.has-row-menu');

  if(toggle){
    const menu=toggle.closest('.menu-wrap')?.querySelector('.menu'); if(!menu) return;
    const isOpen=menu.classList.contains('open');
    if(isOpen) setMenuState(menu,false); else { closeAllMenus(menu); setMenuState(menu,true); }
    return;
  }
  if(item){
    if(item.dataset.themeOption){ applyTheme(item.dataset.themeOption); }
    else{
      const id=item.dataset.id;
      if(item.dataset.action==='edit') editar(id);
      else if(item.dataset.action==='label') etiquetar(id);
      else if(item.dataset.action==='delete') borrar(id);
    }
    closeAllMenus(); return;
  }

  // Cierra si haces clic FUERA de la fila activa
  const openMenu = document.querySelector('.menu.open');
  if(openMenu){
    const openRow = openMenu.closest('tr.has-row-menu');
    if(!rowTrigger || rowTrigger !== openRow){ setMenuState(openMenu,false); }
  }

  // Si clicas completamente fuera de cualquier fila/menu, cierra todo
  if(!wrap && !rowTrigger){ closeAllMenus(); }
});
if(tbody){
  tbody.addEventListener('click',(e)=>{
    const row=e.target.closest('tr.has-row-menu'); if(!row || !tbody.contains(row)) return;
    if(e.target.closest('.menu')) return;
    const menu=row.querySelector('.menu'); if(!menu) return;
    const isOpen=menu.classList.contains('open');
    if(isOpen) setMenuState(menu,false); else { closeAllMenus(menu); setMenuState(menu,true); }
  });
  tbody.addEventListener('keydown',(e)=>{
    if(e.key!=='Enter' && e.key!==' ') return;
    const row=e.target.closest('tr.has-row-menu'); if(!row || !tbody.contains(row)) return;
    const menu=row.querySelector('.menu'); if(!menu) return;
    e.preventDefault();
    const isOpen=menu.classList.contains('open');
    if(isOpen){ setMenuState(menu,false); } else { closeAllMenus(menu); setMenuState(menu,true); const first=menu.querySelector('.menu-item'); first?.focus(); }
  });
}
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeAllMenus(); });

/* ===== Botones + y ‚àí de servicios ===== */
$('#btnAgregarServicio').onclick = async ()=>{
  const nombre = (prompt('Nombre del nuevo servicio:') || '').trim();
  if (!nombre) return;
  const actuales = await db.fetchServicios();
  if (!actuales.includes(nombre)) {
    actuales.push(nombre); actuales.sort((a,b)=>a.localeCompare(b)); await db.replaceServicios(actuales);
    toast(currentUser ? 'Servicio agregado ‚úì' : 'Servicio agregado (local) ‚úì  Accede para guardar en la nube');
    await renderServicios(nombre);
  } else { await renderServicios(nombre); toast('Ese servicio ya existe'); }
};
$('#btnEliminarServicio').onclick = async ()=>{
  const current = f.servicio.value; if (!current) { toast('No hay servicio seleccionado'); return; }
  const actuales = await db.fetchServicios(); if (!actuales.includes(current)) { toast('Ese servicio no est√° en la lista'); return; }
  if (!confirm(`¬øEliminar "${current}" de la lista de servicios?\n(No afecta a los clientes ya guardados).`)) return;
  const nueva = actuales.filter(s => s !== current); await db.replaceServicios(nueva);
  toast(currentUser ? 'Servicio eliminado ‚úì' : 'Servicio eliminado (local) ‚úì  Accede para guardar en la nube'); await renderServicios();
};

/* Mostrar/Ocultar PIN (form) */
document.getElementById('togglePin')?.addEventListener('click',()=>{ const el=f.pin; const isPass=el.type==='password'; el.type=isPass?'text':'password'; document.getElementById('togglePin').textContent=isPass?'üôà':'üëÅ'; });

/* ===== Chat (Gemini) ===== */
const GEMINI_API_KEY = 'AIzaSyC9hpKbGmUx3_YcgVGI3AEOdKvWRSoU81k';
const GEMINI_MODEL  = 'gemini-1.5-flash';
const chatModal = document.getElementById('chatModal');
const btnChatOpen = document.getElementById('btnChatOpen');
const btnChatClose = document.getElementById('btnChatClose');
const chatLogEl = document.getElementById('chatLog');
const chatInputEl = document.getElementById('chatInput');
const CHAT_INPUT_MAX_HEIGHT = 220;
const chatInputMinHeight = chatInputEl ? (()=>{
  const styles = window.getComputedStyle(chatInputEl);
  return parseFloat(styles.minHeight) || parseFloat(styles.height) || 0;
})() : 0;

function adjustChatInputHeight(){
  if(!chatInputEl) return;
  chatInputEl.style.height = 'auto';
  const fullHeight = chatInputEl.scrollHeight;
  const height = Math.max(Math.min(fullHeight, CHAT_INPUT_MAX_HEIGHT), chatInputMinHeight);
  chatInputEl.style.height = `${height}px`;
  chatInputEl.style.overflowY = fullHeight > CHAT_INPUT_MAX_HEIGHT ? 'auto' : 'hidden';
}
if(chatInputEl){
  adjustChatInputHeight();
  chatInputEl.addEventListener('input', adjustChatInputHeight);
}
let chatHistory;
try{
  const stored = JSON.parse(localStorage.getItem('chat_v1')||'[]');
  const cleaned = Array.isArray(stored)? stored.filter(m=>!m?.pending) : [];
  if(Array.isArray(stored) && stored.length!==cleaned.length){
    localStorage.setItem('chat_v1', JSON.stringify(cleaned));
  }
  chatHistory = cleaned;
}catch(_){ chatHistory = []; }

function clearChatHistory(){
  chatHistory = [];
  localStorage.setItem('chat_v1', '[]');
  renderChat();
  toast('Historial del chat vaciado ‚úì');
  chatInputEl?.focus();
}
document.getElementById('btnChatClear')?.addEventListener('click', clearChatHistory);

function openChat(){
  chatModal.classList.add('open');
  chatModal.setAttribute('aria-hidden','false');
  setTimeout(()=>{ adjustChatInputHeight(); chatInputEl?.focus(); }, 0);
}
function closeChat(){ chatModal.classList.remove('open'); chatModal.setAttribute('aria-hidden','true'); }
btnChatOpen?.addEventListener('click', openChat);
btnChatClose?.addEventListener('click', closeChat);
chatModal?.addEventListener('click', (e)=>{ if(e.target===chatModal) closeChat(); });
document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeChat(); });

function renderChat(){
  if(!chatLogEl) return;
  if(!Array.isArray(chatHistory) || chatHistory.length===0){
    chatLogEl.classList.add('is-empty');
    chatLogEl.innerHTML = `
      <div class="chat-empty">
        <span class="chat-empty-emoji" aria-hidden="true">ü§ñ</span>
        <h3>¬°Hola! Soy Zyl0</h3>
        <p>Estoy listo para ayudarte. Escribe tu consulta para iniciar la conversaci√≥n.</p>
      </div>
    `;
    chatLogEl.scrollTop = 0;
    return;
  }
  chatLogEl.classList.remove('is-empty');
  const html = chatHistory.map(m=>{
    const role = m?.role || 'user';
    const isKnownRole = role==='user' || role==='ai';
    const roleClass = role==='user'?'user':'ai';
    if(m?.pending || !isKnownRole){
      return `<div class="chat-msg ${roleClass} loading"><div class="bubble"><span class="chat-spinner" aria-hidden="true"></span><span class="sr-only">Generando respuesta‚Ä¶</span></div></div>`;
    }
    let content;
    if(roleClass==='ai'){
      const formatted = renderMarkdown(m?.text);
      content = formatted || (m?.text ? `<p>${esc(m?.text)}</p>` : '');
    }else{
      content = esc(m?.text);
    }
    return `<div class="chat-msg ${roleClass}"><div class="bubble">${content}</div></div>`;
  }).join('');
  chatLogEl.innerHTML = html;
  chatLogEl.scrollTop = chatLogEl.scrollHeight;
}
renderChat();

function clientToSafe(rec, includeSecrets){
  const d = (function(iso){ if(!iso) return null; const h=new Date();h.setHours(0,0,0,0); const dd=new Date(iso); dd.setHours(0,0,0,0); return Math.round((dd-h)/(1000*60*60*24)); })(rec.vence);
  const est = rec.vence? (d<0?'vencida':(d<=7?'pronto':'vigente')) : '';
  const out = { id:rec.id, nombre:rec.nombre||'', email:rec.email||'', telefono:rec.telefono||'', servicio:rec.servicio||'', inicio:rec.inicio||'', vence:rec.vence||'', categoria:rec.categoria||'', estado:est, dias:d };
  if(includeSecrets){ if(rec.pin) out.pin = rec.pin; if(rec.notas) out.notas = rec.notas; }
  return out;
}
function buildPrompt(userMsg){
  const includeSecrets = document.getElementById('shareSecrets')?.checked || false;
  const textNorm = normalize(userMsg);
  const clientes = db.getAll();
  const enriched = clientes.map(r=>clientToSafe(r, includeSecrets));
  const matches = enriched.filter(r=>{
    const n=normalize(r.nombre), e=normalize(r.email), s=normalize(r.servicio);
    return (n && textNorm.includes(n)) || (e && textNorm.includes(e)) || (s && textNorm.includes(s));
  });
  const context = (matches.length? matches.slice(0,10) : enriched.slice(0,50));
  const guidance = [
    'Eres un asistente que habla espa√±ol y ayuda a gestionar clientes.',
    'Usa SOLO los datos proporcionados. Si algo no est√° en DATOS, di: "no est√° en mis registros".',
    'Si el usuario pide PIN y no existe el campo "pin" en los DATOS, responde brevemente que por seguridad no lo compartes a menos que el usuario habilite Compartir datos sensibles.',
    'Formatea las respuestas de ficha con etiquetas: Nombre, Email, Tel√©fono, Servicio, Inicio, Vence, Estado, D√≠as, Categor√≠a, Notas.'
  ];
  const prompt = [...guidance,'DATOS(JSON):',JSON.stringify(context),`PREGUNTA: ${userMsg}`].join('\n');
  return prompt;
}
async function requestGemini(prompt){
  const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
  const payload = { contents: [{ role:'user', parts:[{ text: prompt }]}] };
  const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const json = await res.json();
  return json?.candidates?.[0]?.content?.parts?.[0]?.text || '(sin respuesta)';
}
async function sendChat(){
  const text = (chatInputEl?.value||'').trim(); if(!text) return;
  chatHistory.push({ role:'user', text });
  chatInputEl.value='';
  adjustChatInputHeight();
  const pendingIndex = chatHistory.push({ role:'ai', pending:true })-1;
  renderChat();
  try{
    const reply = await requestGemini(buildPrompt(text));
    chatHistory[pendingIndex] = { role:'ai', text: reply };
    tryApplyToolFrom(reply, text);
  }
  catch(err){
    const message = err?.message || String(err);
    chatHistory[pendingIndex] = { role:'ai', text: `[Error al llamar a Gemini: ${message}]` };
  }
  chatHistory = chatHistory.filter(m=>!m?.pending);
  localStorage.setItem('chat_v1', JSON.stringify(chatHistory));
  renderChat();
}
document.getElementById('btnSend')?.addEventListener('click', sendChat);
chatInputEl?.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }});

/* ==== Herramientas locales desde chat ==== */
function parseDateToISO(s){
  if(!s) return s; s=String(s).trim();
  if(s.indexOf('-')>0) return s;
  if(s.indexOf('/')>0){ const p=s.split('/'); if(p.length===3){ const d=p[0].padStart(2,'0'); const m=p[1].padStart(2,'0'); const y=p[2]; return `${y}-${m}-${d}`; } }
  return s;
}
function extractJson(text){
  const i = text.indexOf('```json'); if(i>=0){ const j = text.indexOf('```', i+7); if(j>i){ return text.slice(i+7, j).trim(); } }
  const a = text.indexOf('{'); const b = text.lastIndexOf('}');
  if(a>=0 && b>a) return text.slice(a,b+1);
  return null;
}
function tryApplyToolFrom(modelText,_userText){
  const raw = extractJson(modelText); if(!raw) return false;
  let cmd; try{ cmd = JSON.parse(raw); }catch{ return false; }
  if(!cmd || cmd.action !== 'update_client' || !cmd.set) return false;
  return applyUpdateCommand(cmd);
}
function findClientByMatch(match){
  const arr = db.getAll(); const t = m=>normalize(m||'');
  let filtered = arr.filter(c=>{
    const okNombre = match?.nombre? t(c.nombre).includes(t(match.nombre)) : true;
    const okEmail  = match?.email?  t(c.email) === t(match.email) || t(c.email).includes(t(match.email)) : true;
    const okServ   = match?.servicio? t(c.servicio).includes(t(match.servicio)) : true;
    return okNombre && okEmail && okServ;
  });
  return filtered;
}
async function applyUpdateCommand(cmd){
  const matches = findClientByMatch(cmd.match||{});
  if(matches.length !== 1){
    const msg = matches.length===0? 'No encontr√© un cliente con esos datos. Especifica nombre o email.' : `Hay ${matches.length} clientes que coinciden. Especifica email para continuar.`;
    chatHistory.push({role:'ai', text: msg}); renderChat(); return false;
  }
  const client = matches[0];
  const allowed = {nombre:1,email:1,telefono:1,servicio:1,inicio:1,vence:1,categoria:1,notas:1,pin:1};
  const set = Object.assign({}, cmd.set);
  if(set.inicio) set.inicio = parseDateToISO(set.inicio);
  if(set.vence)  set.vence  = parseDateToISO(set.vence);

  const arr = db.getAll();
  const idx = arr.findIndex(x=>x.id===client.id);
  if(idx<0){ chatHistory.push({role:'ai', text:'Error interno: no se pudo ubicar el registro.'}); renderChat(); return false; }
  const before = Object.assign({}, arr[idx]);
  Object.keys(set).forEach(k=>{ if(allowed[k]) arr[idx][k] = set[k]; });
  await db.saveAll(arr); await renderTabla();

  const changed = Object.keys(set).map(k=>`${k}: "${before[k]||''}" ‚Üí "${arr[idx][k]}"`).join('\n');
  chatHistory.push({role:'ai', text:`Actualizado ‚úì\nCliente: ${arr[idx].nombre}\nCambios:\n${changed}`});
  renderChat(); return true;
}

/* ===== Etiquetas ===== */
function formatDM(iso){ if(!iso) return ''; const d=new Date(iso+'T00:00:00'); return String(d.getDate()).padStart(2,'0')+'/'+String(d.getMonth()+1).padStart(2,'0'); }
function buildEtiqueta(c){
  const linkedAccount = findLinkedAccount(c.servicio, c.email);
  const svc = (c.servicio || '').toString().toUpperCase();
  const fv = formatDM(c.vence) || '--/--';
  const correo = c.email || '‚Äî';
  const perfil = c.nombre || '‚Äî';
  const pin = c.pin || '‚Äî';
  const password = linkedAccount?.password || c.password || c.contrasena || c.pass || c.clave || '‚Äî';
  return `‚ú® *${svc || 'SERVICIO'}* 
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üìÖ *Vence:* ${fv}

üë• *Perfil & Acceso*
   ‚Ä¢ Nombre: ${perfil}
   ‚Ä¢ Correo: ${correo}
   ‚Ä¢ Contrase√±a: ${password}
   ‚Ä¢ PIN: ${pin}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üíªüì≤  üåü Gracias por tu compra`;
}
async function copyToClipboard(txt){
  try{ await navigator.clipboard.writeText(txt); return true; }
  catch(e){ try{ var ta=document.createElement('textarea'); ta.value=txt; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); return true; }catch(_){ return false; } }
}
function etiquetar(id){
  var c=db.getAll().find(x=>x.id===id); if(!c){ toast('Cliente no encontrado'); return; }
  var etiqueta = buildEtiqueta(c);
  copyToClipboard(etiqueta).then(ok=> toast(ok?'Etiqueta copiada ‚úì':'No se pudo copiar'));
}

/* ===== B√∫squeda / filtro ===== */
q?.addEventListener('input', () => renderTabla());
filterEstado?.addEventListener('change', () => renderTabla());

/* ===== DEV TESTS (ligeros) ===== */
(function(){
  function runTests(){
    const backupGet = db.getAll, backupSaveAll = db.saveAll;
    let mem = [{id:'1',nombre:'Ana',servicio:'ChatGPT',vence:'2025-10-01',pin:'1234',notas:'vip',email:'ana@x.com'}];
    db.getAll = () => JSON.parse(JSON.stringify(mem));
    db.saveAll = (x) => { mem = JSON.parse(JSON.stringify(x)); };

    console.assert(parseDateToISO('20/10/2025') === '2025-10-20','parseDateToISO convierte dd/mm/aaaa');
    applyUpdateCommand({action:'update_client', match:{nombre:'Ana'}, set:{vence:'2025-11-01'}});
    console.assert(mem[0].vence==='2025-11-01','applyUpdateCommand actualiza vence');

    db.getAll = backupGet; db.saveAll = backupSaveAll;
    console.log('[tests] OK');
  }
  try{ runTests(); }catch(e){ console.warn('[tests] fallo:', e); }
})();

/* inicio */
if(document.readyState==='complete'){
  document.body.classList.add('page-loaded');
} else {
  window.addEventListener('load', () => document.body.classList.add('page-loaded'));
}
renderServicios().then(()=>renderTabla());
</script>
</body>
</html>
